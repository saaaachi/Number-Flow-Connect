<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Number Flow Connect</title>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #3b82f6; --text: #f8fafc; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; user-select: none; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        
        /* Â∫ÉÂëä„Ç®„É™„Ç¢ */
        .ad-container { width: 100%; height: 60px; background: #000; display: flex; justify-content: center; align-items: center; z-index: 200; transition: opacity 0.5s; }
        iframe.ad-frame { width: 100%; height: 100%; border: none; }

        /* „Çπ„Çø„Éº„Éà„Éª„É™„Ç∂„É´„Éà„Éª„Ç∑„Éß„ÉÉ„ÉóÂ∞èÁ™ì */
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 300; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 320px; background: var(--panel); border: 2px solid var(--accent); border-radius: 20px; z-index: 400; padding: 20px; display: none; box-shadow: 0 0 30px rgba(0,0,0,0.8); }
        
        h1 { font-size: 24px; color: #facc15; margin-bottom: 20px; }
        .menu-btn { width: 220px; padding: 12px; margin: 8px; border-radius: 12px; border: none; background: var(--accent); color: white; font-weight: bold; font-size: 16px; cursor: pointer; }
        
        /* „Ç≤„Éº„É†„É¨„Ç§„Ç¢„Ç¶„Éà */
        #game-content { display: none; flex-direction: column; align-items: center; width: 100%; flex: 1; justify-content: center; }
        #game-outer { position: relative; padding: 10px; background: var(--panel); border-radius: 15px; touch-action: none; }
        
        /* „Éû„ÇπÁõÆ„ÅÆÂùáÁ≠âÈÖçÁΩÆ */
        #grid { display: grid; width: 300px; height: 300px; gap: 4px; position: relative; z-index: 1; }
        .cell { background: #334155; border-radius: 6px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        
        /* Á∑ö„Çà„Çä„ÇÇ‰∏ä„Å´„Åè„ÇãË¶ÅÁ¥† */
        canvas { position: absolute; top: 10px; left: 10px; pointer-events: none; z-index: 5; }
        .dot { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; z-index: 10; position: relative; border: 2px solid rgba(255,255,255,0.4); background-color: inherit; }
        .rock { font-size: 26px; z-index: 10; position: relative; background: #334155; border-radius: 50%; }

        .stats-bar { font-size: 16px; color: #facc15; font-weight: bold; display: flex; gap: 20px; margin-bottom: 10px; }
        #ad-large-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background:#000; }
        #ad-close-btn { position: absolute; top: 20px; right: 20px; padding: 10px 15px; background: #ef4444; color: white; border: none; border-radius: 5px; display: none; font-weight: bold; }
    </style>
</head>
<body>

    <div id="ad-top" class="ad-container"></div>

    <div id="start-screen" class="screen">
        <h1>Number Flow<br>Connect</h1>
        <p style="font-size:11px; color:#94a3b8; margin-bottom:15px;">‚ÄªLINE„ÅÆÊñπ„ÅØ„Äå„Éñ„É©„Ç¶„Ç∂„ÅßÈñã„Åè„Äç„ÇíÊé®Â•®</p>
        <button class="menu-btn" onclick="startGame()" style="background:#22c55e;">START</button>
        <button class="menu-btn" onclick="openModal('shop-modal')">SHOP</button>
        <a href="https://saaaachi.github.io/Sort-Master/" style="color:#94a3b8; font-size:12px; margin-top:15px;">Other Games: Sort Master</a>
        <div class="stats-bar" style="margin-top:20px;">üí∞ <span id="start-coins">0</span></div>
    </div>

    <div id="shop-modal" class="modal">
        <h1>SHOP</h1>
        <div id="shop-list"></div>
        <button class="menu-btn" onclick="closeModal('shop-modal')" style="background:#64748b; margin-top:15px;">CLOSE</button>
    </div>

    <div id="result-screen" class="screen" style="display:none;">
        <h1 id="res-title">CLEARED!</h1>
        <div style="font-size:24px; margin-bottom:20px; color:#facc15;">üí∞ +<span id="res-coins">0</span></div>
        <button class="menu-btn" onclick="startGame()" style="background:#22c55e;">NEXT STAGE</button>
        <button class="menu-btn" onclick="backToStart()" style="background:#64748b;">HOME</button>
    </div>

    <div id="game-content">
        <div class="stats-bar">
            <span>Stage: <span id="ui-stage">1</span></span>
            <span>üí∞ <span id="ui-coins">0</span></span>
        </div>
        <div id="game-outer">
            <div id="grid"></div>
            <canvas id="line-canvas"></canvas>
        </div>
        <button class="menu-btn" onclick="initStage()" style="background:#ef4444; width:120px; margin-top:15px; font-size:14px;">RESET</button>
    </div>

    <div id="ad-bottom" class="ad-container" style="opacity:0;"></div>

    <div id="ad-large-overlay">
        <iframe id="ad-large-frame" style="width:100%; height:100%; border:none;"></iframe>
        <div id="ad-timer" style="position:absolute; top:20px; right:20px; color:white; background:rgba(0,0,0,0.5); padding:10px; border-radius:5px;">5s...</div>
        <button id="ad-close-btn" onclick="closeLargeAd()">Close [X]</button>
    </div>

    <script>
        const allStages = {
            1: {"size":5,"dots":[{"x":0,"y":0,"val":1,"color":"#ef4444"},{"x":4,"y":0,"val":1,"color":"#ef4444"},{"x":0,"y":2,"val":2,"color":"#3b82f6"},{"x":4,"y":2,"val":2,"color":"#3b82f6"},{"x":0,"y":4,"val":3,"color":"#22c55e"},{"x":4,"y":4,"val":3,"color":"#22c55e"}]},
            2: {"size":5,"dots":[{"x":2,"y":1,"val":1,"color":"#ef4444"},{"x":2,"y":3,"val":1,"color":"#ef4444"},{"x":0,"y":0,"val":2,"color":"#3b82f6"},{"x":1,"y":0,"val":2,"color":"#3b82f6"},{"x":1,"y":1,"val":3,"color":"#22c55e"},{"x":1,"y":3,"val":3,"color":"#22c55e"}]},
            3: {"size":5,"dots":[{"x":0,"y":0,"val":1,"color":"#ef4444"},{"x":4,"y":4,"val":1,"color":"#ef4444"},{"x":1,"y":1,"val":2,"color":"#3b82f6"},{"x":3,"y":3,"val":2,"color":"#3b82f6"},{"x":2,"y":1,"val":3,"color":"#22c55e"},{"x":3,"y":0,"val":3,"color":"#22c55e"}]},
            4: {"size":5,"dots":[{"x":2,"y":1,"val":1,"color":"#ef4444"},{"x":2,"y":3,"val":1,"color":"#ef4444"},{"x":0,"y":0,"val":2,"color":"#3b82f6"},{"x":4,"y":0,"val":2,"color":"#3b82f6"},{"x":1,"y":0,"val":3,"color":"#22c55e"},{"x":1,"y":2,"val":3,"color":"#22c55e"},{"x":3,"y":0,"val":4,"color":"#facc15"},{"x":3,"y":2,"val":4,"color":"#facc15"}]},
            5: {"size":5,"dots":[{"x":0,"y":0,"val":1,"color":"#ef4444"},{"x":2,"y":2,"val":1,"color":"#ef4444"},{"x":1,"y":1,"val":2,"color":"#3b82f6"},{"x":3,"y":3,"val":2,"color":"#3b82f6"},{"x":1,"y":0,"val":3,"color":"#22c55e"},{"x":4,"y":3,"val":3,"color":"#22c55e"},{"x":0,"y":3,"val":4,"color":"#facc15"},{"x":4,"y":4,"val":4,"color":"#facc15"}]},
            6: {"size":5,"dots":[{"x":1,"y":1,"val":1,"color":"#ef4444"},{"x":2,"y":3,"val":1,"color":"#ef4444"},{"x":1,"y":2,"val":2,"color":"#3b82f6"},{"x":4,"y":2,"val":2,"color":"#3b82f6"},{"x":3,"y":2,"val":3,"color":"#22c55e"},{"x":3,"y":0,"val":3,"color":"#22c55e"},{"x":2,"y":0,"val":4,"color":"#facc15"},{"x":0,"y":0,"val":4,"color":"#facc15"}]},
            7: {"size":5,"dots":[{"x":4,"y":0,"val":1,"color":"#ef4444"},{"x":3,"y":4,"val":1,"color":"#ef4444"},{"x":4,"y":2,"val":2,"color":"#3b82f6"},{"x":1,"y":2,"val":2,"color":"#3b82f6"},{"x":1,"y":3,"val":3,"color":"#22c55e"},{"x":4,"y":4,"val":3,"color":"#22c55e"},{"x":1,"y":1,"val":4,"color":"#facc15"},{"x":2,"y":1,"val":4,"color":"#facc15"},{"x":3,"y":1,"val":5,"color":"#a855f7"},{"x":4,"y":1,"val":5,"color":"#a855f7"}]}
        };

        let user = { coins: 0, sLv: 1, unlockedMaker: false, clearCount: 0 };
        let dots = [], completedPaths = [], currentPath = [], gridSize = 5, isDragging = false, activeColor = null;
        const ctx = document.getElementById('line-canvas').getContext('2d');

        function load() {
            const saved = localStorage.getItem('flow_final_save');
            if(saved) user = Object.assign(user, JSON.parse(saved));
            updateStats();
            startAdTimer();
        }
        function save() { localStorage.setItem('flow_final_save', JSON.stringify(user)); }
        function updateStats() {
            document.getElementById('start-coins').innerText = user.coins;
            document.getElementById('ui-coins').innerText = user.coins;
            document.getElementById('ui-stage').innerText = user.sLv;
        }

        function openModal(id) {
            if(id === 'shop-modal') {
                document.getElementById('shop-list').innerHTML = `
                    <button class="menu-btn" style="background:#8b5cf6; font-size:14px;" onclick="buyMaker()">
                        ${user.unlockedMaker ? 'MAKER: UNLOCKED' : 'UNLOCK MAKER (5000)'}
                    </button>
                    <button class="menu-btn" style="background:#6366f1; font-size:14px; opacity:0.6;">MORE ITEMS (SOON)</button>
                `;
            }
            document.getElementById(id).style.display = 'block';
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function buyMaker() {
            if(user.unlockedMaker) { window.open('maker.html', '_blank'); return; }
            if(user.coins >= 5000) {
                user.coins -= 5000; user.unlockedMaker = true;
                save(); openModal('shop-modal');
            } else alert("Not enough coins!");
        }

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('game-content').style.display = 'flex';
            initStage();
        }
        function backToStart() {
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('game-content').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
            updateStats();
        }

        function initStage() {
            const data = allStages[user.sLv] || allStages[1];
            gridSize = data.size; dots = data.dots;
            completedPaths = []; currentPath = [];
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            dots.forEach(d => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.style.gridColumnStart = d.x + 1; cell.style.gridRowStart = d.y + 1;
                if(d.val === 0) cell.innerHTML = '<span class="rock">ü™®</span>';
                else {
                    const dot = document.createElement('div');
                    dot.className = 'dot'; dot.style.backgroundColor = d.color; dot.innerText = d.val;
                    cell.appendChild(dot);
                }
                grid.appendChild(cell);
            });
            for(let i=0; i<gridSize*gridSize; i++) {
                const x = i%gridSize, y = Math.floor(i/gridSize);
                if(!dots.find(d => d.x === x && d.y === y)) {
                    const cell = document.createElement('div'); cell.className = 'cell'; grid.appendChild(cell);
                }
            }
            draw();
        }

        function getPos(e) {
            const rect = document.getElementById('grid').getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            const x = Math.floor((touch.clientX - rect.left) / (rect.width / gridSize));
            const y = Math.floor((touch.clientY - rect.top) / (rect.height / gridSize));
            return (x>=0 && x<gridSize && y>=0 && y<gridSize) ? {x, y} : null;
        }

        document.getElementById('grid').addEventListener('touchstart', (e) => {
            const pos = getPos(e); if(!pos) return;
            const dot = dots.find(d => d.x === pos.x && d.y === pos.y && d.val !== 0);
            if(dot) {
                isDragging = true; activeColor = dot.color;
                completedPaths = completedPaths.filter(p => dots.find(d => d.x === p[0].x && d.y === p[0].y).color !== activeColor);
                currentPath = [pos]; draw();
            }
        });

        document.getElementById('grid').addEventListener('touchmove', (e) => {
            if(!isDragging) return;
            const pos = getPos(e); if(!pos) return;
            const last = currentPath[currentPath.length-1];
            if(pos.x === last.x && pos.y === last.y) return;
            if(Math.abs(pos.x - last.x) + Math.abs(pos.y - last.y) === 1) {
                if(dots.find(d => d.x === pos.x && d.y === pos.y && d.val === 0)) return;
                if(completedPaths.some(p => p.some(pt => pt.x === pos.x && pt.y === pos.y))) return;
                if(currentPath.some(pt => pt.x === pos.x && pt.y === pos.y)) {
                    if(currentPath.length > 1 && pos.x === currentPath[currentPath.length-2].x && pos.y === currentPath[currentPath.length-2].y) currentPath.pop();
                } else {
                    currentPath.push(pos);
                    const goal = dots.find(d => d.x === pos.x && d.y === pos.y);
                    if(goal && goal.color === activeColor) { completedPaths.push([...currentPath]); isDragging = false; checkClear(); }
                }
                draw();
            }
        });
        window.addEventListener('touchend', () => { isDragging = false; currentPath = []; draw(); });

        function draw() {
            ctx.clearRect(0,0,300,300);
            const s = 300 / gridSize;
            const drawP = (p, c) => {
                ctx.beginPath(); ctx.strokeStyle = c; ctx.lineWidth = 12; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                p.forEach((pt, i) => {
                    const x = pt.x * s + s/2, y = pt.y * s + s/2;
                    if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.lineWidth = 4; ctx.stroke();
            };
            completedPaths.forEach(p => drawP(p, dots.find(d => d.x === p[0].x && d.y === p[0].y).color));
            if(currentPath.length > 0) drawP(currentPath, activeColor);
        }

        function checkClear() {
            if(completedPaths.length === dots.filter(d => d.val !== 0).length / 2) {
                let bonus = 0; completedPaths.forEach(p => bonus += (p.length-2)*10);
                const total = (completedPaths.length * 100) + bonus;
                user.coins += total; user.clearCount++;
                if(allStages[user.sLv + 1]) user.sLv++;
                save(); setTimeout(() => showResult(total, user.sLv - 1), 500);
            }
        }

        function showResult(gain, lv) {
            document.getElementById('res-coins').innerText = gain;
            document.getElementById('res-title').innerText = "STAGE " + lv + " CLEAR!";
            document.getElementById('game-content').style.display = 'none';
            document.getElementById('result-screen').style.display = 'flex';
            if(user.clearCount === 2 || user.clearCount % 5 === 0) showLargeAd();
        }

        // --- Â∫ÉÂëä ---
        function startAdTimer() {
            let topActive = true;
            const topBox = document.getElementById('ad-top');
            const bottomBox = document.getElementById('ad-bottom');
            
            setInterval(() => {
                if(topActive) {
                    topBox.style.opacity = '0'; bottomBox.style.opacity = '1';
                    bottomBox.innerHTML = '<iframe src="ad.html" class="ad-frame"></iframe>';
                    setTimeout(() => { topBox.innerHTML = ''; }, 500);
                } else {
                    bottomBox.style.opacity = '0'; topBox.style.opacity = '1';
                    topBox.innerHTML = '<iframe src="ad.html" class="ad-frame"></iframe>';
                    setTimeout(() => { bottomBox.innerHTML = ''; }, 500);
                }
                topActive = !topActive;
            }, 30000);
            topBox.innerHTML = '<iframe src="ad.html" class="ad-frame"></iframe>';
        }

        function showLargeAd() {
            document.getElementById('ad-large-frame').src = 'ad.large.html';
            document.getElementById('ad-large-overlay').style.display = 'block';
            document.getElementById('ad-close-btn').style.display = 'none';
            let sec = 5;
            const timerDiv = document.getElementById('ad-timer');
            timerDiv.style.display = 'block';
            timerDiv.innerText = sec + "s...";
            const interval = setInterval(() => {
                sec--;
                if(sec <= 0) {
                    clearInterval(interval);
                    timerDiv.style.display = 'none';
                    document.getElementById('ad-close-btn').style.display = 'block';
                } else timerDiv.innerText = sec + "s...";
            }, 1000);
        }
        function closeLargeAd() { document.getElementById('ad-large-overlay').style.display = 'none'; }

        window.onload = load;
    </script>
</body>
</html>
