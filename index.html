<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Number Flow Connect</title>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #3b82f6; --text: #f8fafc; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; user-select: none; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        
        /* Â∫ÉÂëä„Ç®„É™„Ç¢ */
        #ad-container { width: 100%; height: 60px; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; z-index: 200; }
        iframe.ad-frame { width: 100%; height: 100%; border: none; }

        /* „Çπ„Çø„Éº„Éà„Éª„É™„Ç∂„É´„ÉàÁîªÈù¢ÂÖ±ÈÄö */
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 300; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        h1 { font-size: 28px; color: #facc15; margin-bottom: 30px; }
        .menu-btn { width: 240px; padding: 15px; margin: 10px; border-radius: 12px; border: none; background: var(--accent); color: white; font-weight: bold; font-size: 18px; cursor: pointer; }
        .other-game { font-size: 14px; color: #94a3b8; text-decoration: underline; margin-top: 20px; }

        /* „É°„Ç§„É≥„Ç≤„Éº„É†„É¨„Ç§„Ç¢„Ç¶„Éà */
        #game-content { display: none; flex-direction: column; align-items: center; width: 100%; flex: 1; }
        #header { width: 100%; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        #game-outer { position: relative; padding: 15px; background: var(--panel); border-radius: 15px; margin: 20px 0; touch-action: none; }
        #grid { display: grid; width: 300px; height: 300px; gap: 5px; position: relative; z-index: 1; }
        canvas { position: absolute; top: 15px; left: 15px; pointer-events: none; z-index: 5; } /* Á∑ö„ÇíËÉåÊôØ„ÅÆ‰∏ä„ÄÅÊï∞Â≠ó„ÅÆ‰∏ã„Å´ */
        
        .cell { background: #334155; border-radius: 8px; display: flex; align-items: center; justify-content: center; position: relative; }
        .dot { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; z-index: 10; position: relative; border: 2px solid rgba(255,255,255,0.4); }
        .rock { font-size: 26px; z-index: 10; position: relative; }

        .stats-bar { font-size: 16px; color: #facc15; font-weight: bold; display: flex; gap: 20px; }
    </style>
</head>
<body>

    <div id="ad-top" class="ad-container"></div>

    <div id="start-screen" class="screen">
        <h1>Number Flow<br>Connect</h1>
        <p style="font-size:12px; color:#94a3b8; margin-bottom:20px;">‚ÄªLINE„ÅÆÊñπ„ÅØ„Äå„Éñ„É©„Ç¶„Ç∂„ÅßÈñã„Åè„Äç„ÇíÊé®Â•®</p>
        <button class="menu-btn" onclick="startGame()" style="background:#22c55e;">START</button>
        <button class="menu-btn" onclick="showShop()">SHOP</button>
        <a href="https://saaaachi.github.io/Sort-Master/" class="other-game" target="_blank">Other Games: Sort Master</a>
        <div class="stats-bar" style="margin-top:30px;">üí∞ <span id="start-coins">0</span></div>
    </div>

    <div id="shop-screen" class="screen" style="display:none;">
        <h1>SHOP</h1>
        <div id="shop-items" style="width:100%; max-width:300px;"></div>
        <button class="menu-btn" onclick="backToStart()" style="background:#64748b;">BACK</button>
    </div>

    <div id="result-screen" class="screen" style="display:none;">
        <h1 id="res-title">CLEARED!</h1>
        <div style="font-size:24px; margin-bottom:20px;">üí∞ +<span id="res-coins">0</span></div>
        <button class="menu-btn" onclick="startGame()" id="next-btn" style="background:#22c55e;">NEXT STAGE</button>
        <button class="menu-btn" onclick="backToStart()" style="background:#64748b;">HOME</button>
    </div>

    <div id="game-content">
        <div id="header">
            <div style="font-weight:bold;">Stage: <span id="ui-stage">1</span></div>
            <div class="stats-bar">üí∞ <span id="ui-coins">0</span></div>
        </div>
        <div id="game-outer">
            <div id="grid"></div>
            <canvas id="line-canvas"></canvas>
        </div>
        <button class="menu-btn" onclick="initStage()" style="background:#ef4444; width:120px; padding:10px; font-size:14px;">RESET</button>
    </div>

    <div id="ad-bottom" class="ad-container"></div>

    <div id="ad-large-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:1000; background:#000;">
        <iframe id="ad-large-frame" style="width:100%; height:100%; border:none;"></iframe>
        <button onclick="closeLargeAd()" style="position:absolute; top:20px; right:20px; padding:10px; background:rgba(255,255,255,0.5); border:none; border-radius:5px;">Close [X]</button>
    </div>

    <script>
        // --- „Éá„Éº„ÇøË®≠ÂÆö ---
        const allStages = {
            1: {"size":5,"dots":[{"x":0,"y":0,"val":1,"color":"#ef4444"},{"x":4,"y":0,"val":1,"color":"#ef4444"},{"x":0,"y":2,"val":2,"color":"#3b82f6"},{"x":4,"y":2,"val":2,"color":"#3b82f6"},{"x":0,"y":4,"val":3,"color":"#22c55e"},{"x":4,"y":4,"val":3,"color":"#22c55e"}]},
            2: {"size":5,"dots":[{"x":2,"y":1,"val":1,"color":"#ef4444"},{"x":2,"y":3,"val":1,"color":"#ef4444"},{"x":0,"y":0,"val":2,"color":"#3b82f6"},{"x":1,"y":0,"val":2,"color":"#3b82f6"},{"x":1,"y":1,"val":3,"color":"#22c55e"},{"x":1,"y":3,"val":3,"color":"#22c55e"}]},
            3: {"size":5,"dots":[{"x":0,"y":0,"val":1,"color":"#ef4444"},{"x":4,"y":4,"val":1,"color":"#ef4444"},{"x":1,"y":1,"val":2,"color":"#3b82f6"},{"x":3,"y":3,"val":2,"color":"#3b82f6"},{"x":2,"y":1,"val":3,"color":"#22c55e"},{"x":3,"y":0,"val":3,"color":"#22c55e"}]},
            4: {"size":5,"dots":[{"x":2,"y":1,"val":1,"color":"#ef4444"},{"x":2,"y":3,"val":1,"color":"#ef4444"},{"x":0,"y":0,"val":2,"color":"#3b82f6"},{"x":4,"y":0,"val":2,"color":"#3b82f6"},{"x":1,"y":0,"val":3,"color":"#22c55e"},{"x":1,"y":2,"val":3,"color":"#22c55e"},{"x":3,"y":0,"val":4,"color":"#facc15"},{"x":3,"y":2,"val":4,"color":"#facc15"}]},
            5: {"size":5,"dots":[{"x":0,"y":0,"val":1,"color":"#ef4444"},{"x":2,"y":2,"val":1,"color":"#ef4444"},{"x":1,"y":1,"val":2,"color":"#3b82f6"},{"x":3,"y":3,"val":2,"color":"#3b82f6"},{"x":1,"y":0,"val":3,"color":"#22c55e"},{"x":4,"y":3,"val":3,"color":"#22c55e"},{"x":0,"y":3,"val":4,"color":"#facc15"},{"x":4,"y":4,"val":4,"color":"#facc15"}]},
            6: {"size":5,"dots":[{"x":1,"y":1,"val":1,"color":"#ef4444"},{"x":2,"y":3,"val":1,"color":"#ef4444"},{"x":1,"y":2,"val":2,"color":"#3b82f6"},{"x":4,"y":2,"val":2,"color":"#3b82f6"},{"x":3,"y":2,"val":3,"color":"#22c55e"},{"x":3,"y":0,"val":3,"color":"#22c55e"},{"x":2,"y":0,"val":4,"color":"#facc15"},{"x":0,"y":0,"val":4,"color":"#facc15"}]},
            7: {"size":5,"dots":[{"x":4,"y":0,"val":1,"color":"#ef4444"},{"x":3,"y":4,"val":1,"color":"#ef4444"},{"x":4,"y":2,"val":2,"color":"#3b82f6"},{"x":1,"y":2,"val":2,"color":"#3b82f6"},{"x":1,"y":3,"val":3,"color":"#22c55e"},{"x":4,"y":4,"val":3,"color":"#22c55e"},{"x":1,"y":1,"val":4,"color":"#facc15"},{"x":2,"y":1,"val":4,"color":"#facc15"},{"x":3,"y":1,"val":5,"color":"#a855f7"},{"x":4,"y":1,"val":5,"color":"#a855f7"}]}
        };

        let user = { coins: 0, sLv: 1, unlockedMaker: false, clearCount: 0 };
        let dots = [], completedPaths = [], currentPath = [], gridSize = 5, isDragging = false, activeColor = null;

        const canvas = document.getElementById('line-canvas');
        const ctx = canvas.getContext('2d');

        // --- ÂàùÊúüÂåñ & „Çª„Éº„Éñ ---
        function load() {
            const saved = localStorage.getItem('flow_final_save');
            if(saved) user = Object.assign(user, JSON.parse(saved));
            updateStats();
            startAdTimer();
        }
        function save() { localStorage.setItem('flow_final_save', JSON.stringify(user)); }
        function updateStats() {
            document.getElementById('start-coins').innerText = user.coins;
            document.getElementById('ui-coins').innerText = user.coins;
            document.getElementById('ui-stage').innerText = user.sLv;
        }

        // --- ÁîªÈù¢ÈÅ∑Áßª ---
        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('game-content').style.display = 'flex';
            initStage();
        }
        function backToStart() {
            document.getElementById('shop-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('game-content').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
            updateStats();
        }
        function showShop() {
            document.getElementById('start-screen').style.display = 'none';
            const shopDiv = document.getElementById('shop-items');
            shopDiv.innerHTML = `
                <div class="menu-btn" style="background:#8b5cf6; font-size:14px;" onclick="buyMaker()">
                    ${user.unlockedMaker ? 'MAKER: UNLOCKED' : 'UNLOCK MAKER (5000)'}
                </div>
                <div class="menu-btn" style="background:#6366f1; font-size:14px;">GHOST MODE (COMING SOON)</div>
            `;
            document.getElementById('shop-screen').style.display = 'flex';
        }

        function buyMaker() {
            if(user.unlockedMaker) { location.href = 'maker.html'; return; }
            if(user.coins >= 5000) {
                user.coins -= 5000; user.unlockedMaker = true;
                save(); showShop();
            } else { alert("Not enough coins!"); }
        }

        // --- „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ ---
        function initStage() {
            const data = allStages[user.sLv] || allStages[1];
            gridSize = data.size;
            dots = data.dots;
            completedPaths = []; currentPath = [];
            const grid = document.getElementById('grid');
            grid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
            grid.innerHTML = '';
            
            dots.forEach(d => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.style.gridColumnStart = d.x + 1;
                cell.style.gridRowStart = d.y + 1;
                if(d.val === 0) cell.innerHTML = '<span class="rock">ü™®</span>';
                else cell.innerHTML = `<div class="dot" style="background:${d.color}">${d.val}</div>`;
                grid.appendChild(cell);
            });
            for(let i=0; i<gridSize*gridSize; i++) {
                const x = i%gridSize, y = Math.floor(i/gridSize);
                if(!dots.find(d => d.x === x && d.y === y)) {
                    const cell = document.createElement('div'); cell.className = 'cell'; grid.appendChild(cell);
                }
            }
            resizeCanvas();
        }

        function resizeCanvas() {
            canvas.width = 300; canvas.height = 300;
            draw();
        }

        // --- „Çø„ÉÉ„ÉÅÊìç‰Ωú (ÊîπÂñÑÁâà) ---
        function getPos(e) {
            const rect = document.getElementById('grid').getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            const x = Math.floor((touch.clientX - rect.left) / (rect.width / gridSize));
            const y = Math.floor((touch.clientY - rect.top) / (rect.height / gridSize));
            return (x>=0 && x<gridSize && y>=0 && y<gridSize) ? {x, y} : null;
        }

        document.getElementById('grid').addEventListener('touchstart', (e) => {
            const pos = getPos(e); if(!pos) return;
            const dot = dots.find(d => d.x === pos.x && d.y === pos.y && d.val !== 0);
            if(dot) {
                isDragging = true; activeColor = dot.color;
                completedPaths = completedPaths.filter(p => dots.find(d => d.x === p[0].x && d.y === p[0].y).color !== activeColor);
                currentPath = [pos];
                draw();
            }
        });

        document.getElementById('grid').addEventListener('touchmove', (e) => {
            if(!isDragging) return;
            const pos = getPos(e); if(!pos) return;
            const last = currentPath[currentPath.length-1];
            if(pos.x === last.x && pos.y === last.y) return;
            if(Math.abs(pos.x - last.x) + Math.abs(pos.y - last.y) === 1) {
                if(dots.find(d => d.x === pos.x && d.y === pos.y && d.val === 0)) return;
                if(completedPaths.some(p => p.some(pt => pt.x === pos.x && pt.y === pos.y))) return;
                if(currentPath.some(pt => pt.x === pos.x && pt.y === pos.y)) {
                    if(currentPath.length > 1 && pos.x === currentPath[currentPath.length-2].x && pos.y === currentPath[currentPath.length-2].y) currentPath.pop();
                } else {
                    currentPath.push(pos);
                    const goal = dots.find(d => d.x === pos.x && d.y === pos.y);
                    if(goal) {
                        if(goal.color === activeColor) { completedPaths.push([...currentPath]); isDragging = false; checkClear(); }
                        else isDragging = false;
                    }
                }
                draw();
            }
        });
        window.addEventListener('touchend', () => { isDragging = false; currentPath = []; draw(); });

        function draw() {
            ctx.clearRect(0,0,300,300);
            const s = 300 / gridSize;
            const drawP = (p, c) => {
                ctx.beginPath(); ctx.strokeStyle = c; ctx.lineWidth = 12; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                p.forEach((pt, i) => {
                    const x = pt.x * s + s/2, y = pt.y * s + s/2;
                    if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.lineWidth = 4; ctx.stroke();
            };
            completedPaths.forEach(p => drawP(p, dots.find(d => d.x === p[0].x && d.y === p[0].y).color));
            if(currentPath.length > 0) drawP(currentPath, activeColor);
        }

        function checkClear() {
            if(completedPaths.length === dots.filter(d => d.val !== 0).length / 2) {
                let bonus = 0; completedPaths.forEach(p => bonus += (p.length-2)*10);
                const total = (completedPaths.length * 100) + bonus;
                user.coins += total; user.clearCount++;
                const currentLv = user.sLv;
                if(allStages[user.sLv + 1]) user.sLv++;
                save();
                setTimeout(() => showResult(total, currentLv), 500);
            }
        }

        function showResult(gain, lv) {
            document.getElementById('res-coins').innerText = gain;
            document.getElementById('res-title').innerText = "STAGE " + lv + " CLEAR!";
            document.getElementById('game-content').style.display = 'none';
            document.getElementById('result-screen').style.display = 'flex';
            if(user.clearCount === 2 || user.clearCount % 5 === 0) showLargeAd();
        }

        // --- Â∫ÉÂëä„É≠„Ç∏„ÉÉ„ÇØ ---
        function startAdTimer() {
            let isTop = true;
            setInterval(() => {
                const target = isTop ? 'ad-top' : 'ad-bottom';
                const other = isTop ? 'ad-bottom' : 'ad-top';
                document.getElementById(target).innerHTML = '<iframe src="ad.html" class="ad-frame"></iframe>';
                document.getElementById(other).innerHTML = '';
                isTop = !isTop;
            }, 30000);
            document.getElementById('ad-top').innerHTML = '<iframe src="ad.html" class="ad-frame"></iframe>';
        }
        function showLargeAd() {
            document.getElementById('ad-large-frame').src = 'ad.large.html';
            document.getElementById('ad-large-overlay').style.display = 'block';
        }
        function closeLargeAd() {
            document.getElementById('ad-large-overlay').style.display = 'none';
            document.getElementById('ad-large-frame').src = '';
        }

        window.onload = load;
    </script>
</body>
</html>
