<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Number Flow Connect</title>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #3b82f6; --text: #f8fafc; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; user-select: none; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ä¸Šä¸‹åºƒå‘Šæ  */
        .ad-area { width: 100%; height: 65px; background: #000; flex-shrink: 0; display: flex; justify-content: center; align-items: center; z-index: 1000; }
        iframe.ad-frame { width: 100%; height: 100%; border: none; }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…¨ä½“ã®ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆåºƒå‘Šã‚’é™¤ã„ãŸæ®‹ã‚Šå…¨éƒ¨ï¼‰ */
        .content-wrapper { flex: 1; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: space-evenly; overflow-y: auto; width: 100%; padding: 10px; }

        /* å„ç”»é¢ã®åˆ¶å¾¡ */
        .screen { display: none; flex-direction: column; align-items: center; width: 100%; }
        .screen.active { display: flex; }

        h1 { font-size: 22px; color: #facc15; margin-bottom: 10px; }
        
        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®ã‚·ãƒ§ãƒƒãƒ—å•†å“ */
        .shop-box { background: var(--panel); padding: 12px; border-radius: 12px; width: 90%; max-width: 300px; margin-top: 10px; border: 1px solid #334155; }
        .item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 13px; }
        .buy-btn { padding: 6px 10px; border-radius: 6px; border: none; background: #8b5cf6; color: white; cursor: pointer; font-weight: bold; }
        .buy-btn.unlocked { background: #475569; cursor: default; }

        .main-btn { width: 200px; padding: 12px; border-radius: 12px; border: none; background: #22c55e; color: white; font-weight: bold; font-size: 18px; cursor: pointer; margin: 10px 0; }
        
        /* ç›¤é¢ï¼šã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’1:1ã«å›ºå®š */
        #board-area { 
            position: relative; 
            width: 100%; 
            max-width: 320px; 
            aspect-ratio: 1 / 1; 
            background: var(--panel); 
            border-radius: 8px; 
            padding: 8px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        #grid { display: grid; width: 100%; height: 100%; gap: 4px; position: relative; z-index: 10; }
        .cell { background: #334155; border-radius: 4px; display: flex; align-items: center; justify-content: center; position: relative; }
        
        /* æ•°å­—ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .dot { 
            width: 80%; height: 80%; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            color: white; font-weight: bold; font-size: 18px; 
            z-index: 20; position: relative; 
            border: 2px solid rgba(255,255,255,0.6);
        }
        
        canvas { position: absolute; top: 8px; left: 8px; pointer-events: none; z-index: 5; }

        .stats-info { font-size: 16px; color: #facc15; font-weight: bold; margin: 5px 0; }

        /* å¤§ç”»é¢åºƒå‘Šç”¨ */
        #ad-large-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; background:#000; }
        #ad-timer { position: absolute; top: 20px; right: 20px; color: white; background: rgba(0,0,0,0.7); padding: 8px 12px; border-radius: 6px; font-weight: bold; }
        #ad-close { position: absolute; top: 20px; right: 20px; padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 6px; display: none; font-weight: bold; }
    </style>
</head>
<body>

    <div id="ad-top" class="ad-area"></div>

    <div class="content-wrapper">
        <div id="start-screen" class="screen active">
            <h1>Number Flow Connect</h1>
            <div class="stats-info">ğŸ’° <span id="start-coins">0</span></div>
            <button class="main-btn" onclick="changeScreen('game-screen'); initStage();">PLAY START</button>
            
            <div class="shop-box">
                <div style="font-size:11px; color:#94a3b8; margin-bottom:8px;">SHOP / ITEMS</div>
                <div class="item">
                    <span>Creative Mode</span>
                    <button class="buy-btn" id="shop-maker" onclick="buyItem('maker', 5000)">5000C</button>
                </div>
                <div class="item">
                    <span>Infinite Hints</span>
                    <button class="buy-btn" id="shop-hints" onclick="buyItem('hints', 3000)">3000C</button>
                </div>
                <div class="item">
                    <span>No Ads (Perm)</span>
                    <button class="buy-btn" id="shop-noads" onclick="buyItem('noads', 8000)">8000C</button>
                </div>
            </div>
            <a href="https://saaaachi.github.io/Sort-Master/" target="_blank" style="color:#94a3b8; font-size:12px; margin-top:10px;">More Games ğŸ”—</a>
        </div>

        <div id="game-screen" class="screen">
            <div class="stats-info">Lv: <span id="ui-stage">1</span> | ğŸ’° <span id="ui-coins">0</span></div>
            <div id="board-area">
                <div id="grid"></div>
                <canvas id="line-canvas"></canvas>
            </div>
            <button onclick="initStage()" style="background:#ef4444; color:white; border:none; padding:10px 20px; border-radius:8px; margin-top:15px; font-weight:bold;">STAGE RESET</button>
        </div>

        <div id="result-screen" class="screen">
            <h1 id="res-title">CLEARED!</h1>
            <div style="font-size:30px; margin:15px 0; color:#facc15;">ğŸ’° +<span id="res-coins">0</span></div>
            <button class="main-btn" onclick="changeScreen('game-screen'); initStage();">NEXT STAGE</button>
            <button class="main-btn" onclick="changeScreen('start-screen')" style="background:#64748b; font-size:14px;">HOME</button>
        </div>
    </div>

    <div id="ad-bottom" class="ad-area"></div>

    <div id="ad-large-overlay">
        <iframe id="ad-large-frame" style="width:100%; height:100%; border:none;"></iframe>
        <div id="ad-timer">5s...</div>
        <button id="ad-close" onclick="closeLargeAd()">CLOSE [X]</button>
    </div>

    <script>
        const allStages = {
            1: {"size":5,"dots":[{"x":0,"y":0,"val":1,"color":"#ef4444"},{"x":4,"y":0,"val":1,"color":"#ef4444"},{"x":0,"y":2,"val":2,"color":"#3b82f6"},{"x":4,"y":2,"val":2,"color":"#3b82f6"},{"x":0,"y":4,"val":3,"color":"#22c55e"},{"x":4,"y":4,"val":3,"color":"#22c55e"}]},
            2: {"size":5,"dots":[{"x":2,"y":1,"val":1,"color":"#ef4444"},{"x":2,"y":3,"val":1,"color":"#ef4444"},{"x":0,"y":0,"val":2,"color":"#3b82f6"},{"x":1,"y":0,"val":2,"color":"#3b82f6"},{"x":1,"y":1,"val":3,"color":"#22c55e"},{"x":1,"y":3,"val":3,"color":"#22c55e"}]},
            3: {"size":5,"dots":[{"x":0,"y":0,"val":1,"color":"#ef4444"},{"x":4,"y":4,"val":1,"color":"#ef4444"},{"x":1,"y":1,"val":2,"color":"#3b82f6"},{"x":3,"y":3,"val":2,"color":"#3b82f6"},{"x":2,"y":1,"val":3,"color":"#22c55e"},{"x":3,"y":0,"val":3,"color":"#22c55e"}]}
            // ä»¥é™è¿½åŠ å¯èƒ½
        };

        let user = { coins: 0, sLv: 1, clearCount: 0, maker: false, hints: false, noads: false };
        let dots = [], completedPaths = [], currentPath = [], gridSize = 5, isDragging = false, activeColor = null;
        const ctx = document.getElementById('line-canvas').getContext('2d');

        function load() {
            const saved = localStorage.getItem('flow_final_v3');
            if(saved) user = Object.assign(user, JSON.parse(saved));
            updateStats();
            startAdSystem();
        }
        function save() { localStorage.setItem('flow_final_v3', JSON.stringify(user)); }

        function updateStats() {
            document.getElementById('start-coins').innerText = user.coins;
            document.getElementById('ui-coins').innerText = user.coins;
            document.getElementById('ui-stage').innerText = user.sLv;
            
            if(user.maker) { document.getElementById('shop-maker').innerText = "OPEN"; document.getElementById('shop-maker').className = "buy-btn unlocked"; }
            if(user.hints) { document.getElementById('shop-hints').innerText = "ACTIVE"; document.getElementById('shop-hints').className = "buy-btn unlocked"; }
            if(user.noads) { document.getElementById('shop-noads').innerText = "DONE"; document.getElementById('shop-noads').className = "buy-btn unlocked"; }
        }

        function buyItem(id, price) {
            if(user[id]) { if(id === 'maker') window.open('maker.html', '_blank'); return; }
            if(user.coins >= price) {
                user.coins -= price; user[id] = true; save(); updateStats();
            } else { alert("Not enough coins!"); }
        }

        function changeScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function initStage() {
            const data = allStages[user.sLv] || allStages[1];
            gridSize = data.size; dots = data.dots;
            completedPaths = []; currentPath = [];
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
            
            dots.forEach(d => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.style.gridColumnStart = d.x + 1; cell.style.gridRowStart = d.y + 1;
                const dot = document.createElement('div');
                dot.className = 'dot'; dot.style.backgroundColor = d.color; dot.innerText = d.val;
                cell.appendChild(dot);
                grid.appendChild(cell);
            });
            for(let i=0; i<gridSize*gridSize; i++) {
                if(!dots.find(d => d.x === i%gridSize && d.y === Math.floor(i/gridSize))) {
                    const cell = document.createElement('div'); cell.className = 'cell'; grid.appendChild(cell);
                }
            }
            setTimeout(resizeCanvas, 50);
        }

        function resizeCanvas() {
            const area = document.getElementById('board-area');
            const side = area.clientWidth - 16;
            document.getElementById('line-canvas').width = side;
            document.getElementById('line-canvas').height = side;
            draw();
        }

        // --- ã‚¿ãƒƒãƒãƒ­ã‚¸ãƒƒã‚¯ ---
        function getPos(e) {
            const rect = document.getElementById('grid').getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            const x = Math.floor((touch.clientX - rect.left) / (rect.width / gridSize));
            const y = Math.floor((touch.clientY - rect.top) / (rect.height / gridSize));
            return (x>=0 && x<gridSize && y>=0 && y<gridSize) ? {x, y} : null;
        }

        document.getElementById('grid').addEventListener('touchstart', (e) => {
            const pos = getPos(e); if(!pos) return;
            const dot = dots.find(d => d.x === pos.x && d.y === pos.y);
            if(dot) {
                isDragging = true; activeColor = dot.color;
                completedPaths = completedPaths.filter(p => dots.find(d => d.x === p[0].x && d.y === p[0].y).color !== activeColor);
                currentPath = [pos]; draw();
            }
        });

        document.getElementById('grid').addEventListener('touchmove', (e) => {
            if(!isDragging) return;
            const pos = getPos(e); if(!pos) return;
            const last = currentPath[currentPath.length-1];
            if(pos.x === last.x && pos.y === last.y) return;
            if(Math.abs(pos.x - last.x) + Math.abs(pos.y - last.y) === 1) {
                if(completedPaths.some(p => p.some(pt => pt.x === pos.x && pt.y === pos.y))) return;
                if(currentPath.some(pt => pt.x === pos.x && pt.y === pos.y)) {
                    if(currentPath.length > 1 && pos.x === currentPath[currentPath.length-2].x && pos.y === currentPath[currentPath.length-2].y) currentPath.pop();
                } else {
                    currentPath.push(pos);
                    const goal = dots.find(d => d.x === pos.x && d.y === pos.y);
                    if(goal && goal.color === activeColor) { completedPaths.push([...currentPath]); isDragging = false; checkClear(); }
                }
                draw();
            }
        });
        window.addEventListener('touchend', () => { isDragging = false; currentPath = []; draw(); });

        function draw() {
            const side = document.getElementById('line-canvas').width;
            ctx.clearRect(0,0,side,side);
            const s = side / gridSize;
            const drawLine = (p, c) => {
                ctx.beginPath(); ctx.strokeStyle = c; ctx.lineWidth = 14; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                p.forEach((pt, i) => {
                    const x = pt.x * s + s/2; const y = pt.y * s + s/2;
                    if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();
            };
            completedPaths.forEach(p => drawLine(p, dots.find(d => d.x === p[0].x && d.y === p[0].y).color));
            if(currentPath.length > 0) drawLine(currentPath, activeColor);
        }

        function checkClear() {
            if(completedPaths.length === dots.length / 2) {
                const gain = (completedPaths.length * 100);
                user.coins += gain; user.clearCount++;
                const oldLv = user.sLv;
                if(allStages[user.sLv + 1]) user.sLv++;
                save(); 
                setTimeout(() => {
                    document.getElementById('res-coins').innerText = gain;
                    document.getElementById('res-title').innerText = "STAGE " + oldLv + " CLEAR!";
                    changeScreen('result-screen');
                    if(!user.noads && (user.clearCount === 2 || user.clearCount % 5 === 0)) showLargeAd();
                }, 500);
            }
        }

        // --- åºƒå‘Šã‚·ã‚¹ãƒ†ãƒ  ---
        function startAdSystem() {
            const t = document.getElementById('ad-top'), b = document.getElementById('ad-bottom');
            let isTop = true;
            const loop = () => {
                if(isTop) { t.style.visibility = 'visible'; b.style.visibility = 'hidden'; t.innerHTML = '<iframe src="ad.html" class="ad-frame"></iframe>'; b.innerHTML = ''; }
                else { b.style.visibility = 'visible'; t.style.visibility = 'hidden'; b.innerHTML = '<iframe src="ad.html" class="ad-frame"></iframe>'; t.innerHTML = ''; }
                isTop = !isTop;
            };
            loop();
            setInterval(loop, 30000);
        }

        function showLargeAd() {
            document.getElementById('ad-large-frame').src = 'ad.large.html';
            document.getElementById('ad-large-overlay').style.display = 'block';
            let s = 5; const timer = document.getElementById('ad-timer'); timer.style.display = 'block';
            const itv = setInterval(() => {
                s--; if(s<=0) { clearInterval(itv); timer.style.display='none'; document.getElementById('ad-close').style.display='block'; }
                else timer.innerText = s + "s...";
            }, 1000);
        }
        function closeLargeAd() { 
            document.getElementById('ad-large-overlay').style.display = 'none'; 
            document.getElementById('ad-close').style.display = 'none'; 
        }

        window.onload = load;
    </script>
</body>
</html>
