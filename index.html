<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Number Flow Connect</title>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #3b82f6; --text: #f8fafc; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; user-select: none; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        
        /* Â∫ÉÂëä„Ç®„É™„Ç¢ÔºöÈ´ò„Åï„ÇíÂõ∫ÂÆö */
        .ad-container { width: 100%; height: 65px; background: #000; overflow: hidden; z-index: 50; flex-shrink: 0; }
        iframe.ad-frame { width: 100%; height: 100%; border: none; }

        /* „Çπ„ÇØ„É™„Éº„É≥ÂÖ±ÈÄö */
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 300; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        
        /* „Ç∑„Éß„ÉÉ„ÉóÂ∞èÁ™ì */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 400; display: none; }
        .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 300px; background: var(--panel); border: 2px solid var(--accent); border-radius: 20px; padding: 25px; text-align: center; }
        
        h1 { font-size: 26px; color: #facc15; margin-bottom: 20px; }
        .menu-btn { width: 220px; padding: 14px; margin: 8px; border-radius: 12px; border: none; background: var(--accent); color: white; font-weight: bold; font-size: 16px; cursor: pointer; }
        
        /* „Ç≤„Éº„É†„É¨„Ç§„Ç¢„Ç¶„Éà */
        #game-content { display: none; flex-direction: column; align-items: center; width: 100%; flex: 1; justify-content: center; }
        #game-outer { position: relative; padding: 10px; background: var(--panel); border-radius: 12px; }
        
        /* „Ç∞„É™„ÉÉ„Éâ: gap„ÇíÂõ∫ÂÆö */
        #grid { display: grid; width: 300px; height: 300px; gap: 4px; position: relative; z-index: 10; pointer-events: auto; }
        .cell { background: #334155; border-radius: 4px; display: flex; align-items: center; justify-content: center; position: relative; width: 100%; height: 100%; }
        
        /* Á∑ö„ÇíÊèè„Åè„Ç≠„É£„É≥„Éê„Çπ„Çí„Ç∞„É™„ÉÉ„Éâ„ÅÆ„ÄåÁúü‰∏ã„Äç„Å´ÈÖçÁΩÆ */
        canvas { position: absolute; top: 10px; left: 10px; pointer-events: none; z-index: 5; }

        /* Êï∞Â≠ó„ÅÆ„Éá„Ç∂„Ç§„É≥: ËÉåÊôØ„Çí‰∏çÈÄèÊòé„Å´„Åó„Å¶Á∑ö„ÇíÈö†„Åô */
        .dot { 
            width: 80%; height: 80%; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            color: white; font-weight: bold; font-size: 18px; 
            position: relative; z-index: 20;
            border: 2px solid rgba(255,255,255,0.8);
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .rock { font-size: 24px; z-index: 20; position: relative; background: #334155; border-radius: 50%; }

        .stats-bar { font-size: 18px; color: #facc15; font-weight: bold; display: flex; gap: 20px; margin-bottom: 10px; }

        /* Â§ßÁîªÈù¢Â∫ÉÂëä */
        #ad-large-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background:#000; }
        #ad-close-btn { position: absolute; top: 20px; right: 20px; padding: 10px; background: #ef4444; color: white; border: none; border-radius: 5px; display: none; }
    </style>
</head>
<body>

    <div id="ad-top" class="ad-container"></div>

    <div id="start-screen" class="screen">
        <h1>Number Flow<br>Connect</h1>
        <button class="menu-btn" onclick="startGame()" style="background:#22c55e;">START</button>
        <button class="menu-btn" onclick="openShop()">SHOP</button>
        <a href="https://saaaachi.github.io/Sort-Master/" target="_blank" style="color:#94a3b8; font-size:12px; margin-top:15px;">Other Games: Sort Master</a>
        <div class="stats-bar" style="margin-top:20px;">üí∞ <span id="start-coins">0</span></div>
    </div>

    <div id="shop-overlay" class="modal-overlay" onclick="closeShop()">
        <div class="modal" onclick="event.stopPropagation()">
            <h1>SHOP</h1>
            <div id="shop-list"></div>
            <button class="menu-btn" onclick="closeShop()" style="background:#64748b; margin-top:15px;">CLOSE</button>
        </div>
    </div>

    <div id="result-screen" class="screen" style="display:none;">
        <h1 id="res-title">CLEARED!</h1>
        <div style="font-size:28px; margin-bottom:20px; color:#facc15;">üí∞ +<span id="res-coins">0</span></div>
        <button class="menu-btn" onclick="startGame()" style="background:#22c55e;">NEXT STAGE</button>
        <button class="menu-btn" onclick="backToStart()" style="background:#64748b;">HOME</button>
    </div>

    <div id="game-content">
        <div class="stats-bar">
            <span>Lv: <span id="ui-stage">1</span></span>
            <span>üí∞ <span id="ui-coins">0</span></span>
        </div>
        <div id="game-outer">
            <div id="grid"></div>
            <canvas id="line-canvas" width="300" height="300"></canvas>
        </div>
        <button class="menu-btn" onclick="initStage()" style="background:#ef4444; width:100px; margin-top:15px; font-size:12px; padding:8px;">RESET</button>
    </div>

    <div id="ad-bottom" class="ad-container" style="display:none;"></div>

    <div id="ad-large-overlay">
        <iframe id="ad-large-frame" style="width:100%; height:100%; border:none;"></iframe>
        <div id="ad-timer" style="position:absolute; top:20px; right:20px; color:white; background:rgba(0,0,0,0.5); padding:10px;">5s...</div>
        <button id="ad-close-btn" onclick="closeLargeAd()">Close [X]</button>
    </div>

    <script>
        const allStages = {
            1: {"size":5,"dots":[{"x":0,"y":0,"val":1,"color":"#ef4444"},{"x":4,"y":0,"val":1,"color":"#ef4444"},{"x":0,"y":2,"val":2,"color":"#3b82f6"},{"x":4,"y":2,"val":2,"color":"#3b82f6"},{"x":0,"y":4,"val":3,"color":"#22c55e"},{"x":4,"y":4,"val":3,"color":"#22c55e"}]},
            2: {"size":5,"dots":[{"x":2,"y":1,"val":1,"color":"#ef4444"},{"x":2,"y":3,"val":1,"color":"#ef4444"},{"x":0,"y":0,"val":2,"color":"#3b82f6"},{"x":1,"y":0,"val":2,"color":"#3b82f6"},{"x":1,"y":1,"val":3,"color":"#22c55e"},{"x":1,"y":3,"val":3,"color":"#22c55e"}]},
            3: {"size":5,"dots":[{"x":0,"y":0,"val":1,"color":"#ef4444"},{"x":4,"y":4,"val":1,"color":"#ef4444"},{"x":1,"y":1,"val":2,"color":"#3b82f6"},{"x":3,"y":3,"val":2,"color":"#3b82f6"},{"x":2,"y":1,"val":3,"color":"#22c55e"},{"x":3,"y":0,"val":3,"color":"#22c55e"}]},
            4: {"size":5,"dots":[{"x":2,"y":1,"val":1,"color":"#ef4444"},{"x":2,"y":3,"val":1,"color":"#ef4444"},{"x":0,"y":0,"val":2,"color":"#3b82f6"},{"x":4,"y":0,"val":2,"color":"#3b82f6"},{"x":1,"y":0,"val":3,"color":"#22c55e"},{"x":1,"y":2,"val":3,"color":"#22c55e"},{"x":3,"y":0,"val":4,"color":"#facc15"},{"x":3,"y":2,"val":4,"color":"#facc15"}]},
            5: {"size":5,"dots":[{"x":0,"y":0,"val":1,"color":"#ef4444"},{"x":2,"y":2,"val":1,"color":"#ef4444"},{"x":1,"y":1,"val":2,"color":"#3b82f6"},{"x":3,"y":3,"val":2,"color":"#3b82f6"},{"x":1,"y":0,"val":3,"color":"#22c55e"},{"x":4,"y":3,"val":3,"color":"#22c55e"},{"x":0,"y":3,"val":4,"color":"#facc15"},{"x":4,"y":4,"val":4,"color":"#facc15"}]},
            6: {"size":5,"dots":[{"x":1,"y":1,"val":1,"color":"#ef4444"},{"x":2,"y":3,"val":1,"color":"#ef4444"},{"x":1,"y":2,"val":2,"color":"#3b82f6"},{"x":4,"y":2,"val":2,"color":"#3b82f6"},{"x":3,"y":2,"val":3,"color":"#22c55e"},{"x":3,"y":0,"val":3,"color":"#22c55e"},{"x":2,"y":0,"val":4,"color":"#facc15"},{"x":0,"y":0,"val":4,"color":"#facc15"}]},
            7: {"size":5,"dots":[{"x":4,"y":0,"val":1,"color":"#ef4444"},{"x":3,"y":4,"val":1,"color":"#ef4444"},{"x":4,"y":2,"val":2,"color":"#3b82f6"},{"x":1,"y":2,"val":2,"color":"#3b82f6"},{"x":1,"y":3,"val":3,"color":"#22c55e"},{"x":4,"y":4,"val":3,"color":"#22c55e"},{"x":1,"y":1,"val":4,"color":"#facc15"},{"x":2,"y":1,"val":4,"color":"#facc15"},{"x":3,"y":1,"val":5,"color":"#a855f7"},{"x":4,"y":1,"val":5,"color":"#a855f7"}]}
        };

        let user = { coins: 0, sLv: 1, unlockedMaker: false, clearCount: 0 };
        let dots = [], completedPaths = [], currentPath = [], gridSize = 5, isDragging = false, activeColor = null;
        const canvas = document.getElementById('line-canvas');
        const ctx = canvas.getContext('2d');

        function load() {
            const saved = localStorage.getItem('flow_final_save');
            if(saved) user = Object.assign(user, JSON.parse(saved));
            updateStats();
            initAdSystem();
        }
        function save() { localStorage.setItem('flow_final_save', JSON.stringify(user)); }
        function updateStats() {
            document.getElementById('start-coins').innerText = user.coins;
            document.getElementById('ui-coins').innerText = user.coins;
            document.getElementById('ui-stage').innerText = user.sLv;
        }

        function openShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = `<button class="menu-btn" style="background:#8b5cf6;" onclick="buyMaker()">
                ${user.unlockedMaker ? 'MAKER: OPEN' : 'UNLOCK MAKER (5000)'}</button>`;
            document.getElementById('shop-overlay').style.display = 'block';
        }
        function closeShop() { document.getElementById('shop-overlay').style.display = 'none'; }
        function buyMaker() {
            if(user.unlockedMaker) { window.open('maker.html', '_blank'); return; }
            if(user.coins >= 5000) { user.coins -= 5000; user.unlockedMaker = true; save(); openShop(); updateStats(); }
            else alert("Need 5000 coins!");
        }

        function startGame() {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('game-content').style.display = 'flex';
            initStage();
        }
        function backToStart() {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('game-content').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
            updateStats();
        }

        function initStage() {
            const data = allStages[user.sLv] || allStages[1];
            gridSize = data.size; dots = data.dots;
            completedPaths = []; currentPath = [];
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
            
            dots.forEach(d => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.style.gridColumnStart = d.x + 1; cell.style.gridRowStart = d.y + 1;
                if(d.val === 0) cell.innerHTML = '<span class="rock">ü™®</span>';
                else {
                    const dot = document.createElement('div');
                    dot.className = 'dot'; dot.style.backgroundColor = d.color; dot.innerText = d.val;
                    cell.appendChild(dot);
                }
                grid.appendChild(cell);
            });
            for(let i=0; i<gridSize*gridSize; i++) {
                if(!dots.find(d => d.x === i%gridSize && d.y === Math.floor(i/gridSize))) {
                    const cell = document.createElement('div'); cell.className = 'cell'; grid.appendChild(cell);
                }
            }
            draw();
        }

        function getPos(e) {
            const rect = document.getElementById('grid').getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            const x = Math.floor((touch.clientX - rect.left) / (rect.width / gridSize));
            const y = Math.floor((touch.clientY - rect.top) / (rect.height / gridSize));
            return (x>=0 && x<gridSize && y>=0 && y<gridSize) ? {x, y} : null;
        }

        document.getElementById('grid').addEventListener('touchstart', (e) => {
            const pos = getPos(e); if(!pos) return;
            const dot = dots.find(d => d.x === pos.x && d.y === pos.y && d.val !== 0);
            if(dot) {
                isDragging = true; activeColor = dot.color;
                completedPaths = completedPaths.filter(p => dots.find(d => d.x === p[0].x && d.y === p[0].y).color !== activeColor);
                currentPath = [pos]; draw();
            }
        });

        document.getElementById('grid').addEventListener('touchmove', (e) => {
            if(!isDragging) return;
            const pos = getPos(e); if(!pos) return;
            const last = currentPath[currentPath.length-1];
            if(pos.x === last.x && pos.y === last.y) return;
            if(Math.abs(pos.x - last.x) + Math.abs(pos.y - last.y) === 1) {
                if(dots.find(d => d.x === pos.x && d.y === pos.y && d.val === 0)) return;
                if(completedPaths.some(p => p.some(pt => pt.x === pos.x && pt.y === pos.y))) return;
                if(currentPath.some(pt => pt.x === pos.x && pt.y === pos.y)) {
                    if(currentPath.length > 1 && pos.x === currentPath[currentPath.length-2].x && pos.y === currentPath[currentPath.length-2].y) currentPath.pop();
                } else {
                    currentPath.push(pos);
                    const goal = dots.find(d => d.x === pos.x && d.y === pos.y);
                    if(goal && goal.color === activeColor) { completedPaths.push([...currentPath]); isDragging = false; checkClear(); }
                }
                draw();
            }
        });
        window.addEventListener('touchend', () => { isDragging = false; currentPath = []; draw(); });

        function draw() {
            ctx.clearRect(0,0,300,300);
            const s = 300 / gridSize;
            const drawLine = (p, c) => {
                ctx.beginPath(); ctx.strokeStyle = c; ctx.lineWidth = 14; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                p.forEach((pt, i) => {
                    const x = pt.x * s + s/2, y = pt.y * s + s/2;
                    if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.strokeStyle = "rgba(255,255,255,0.2)"; ctx.lineWidth = 4; ctx.stroke();
            };
            completedPaths.forEach(p => drawLine(p, dots.find(d => d.x === p[0].x && d.y === p[0].y).color));
            if(currentPath.length > 0) drawLine(currentPath, activeColor);
        }

        function checkClear() {
            if(completedPaths.length === dots.filter(d => d.val !== 0).length / 2) {
                const total = (completedPaths.length * 100);
                user.coins += total; user.clearCount++;
                const oldLv = user.sLv;
                if(allStages[user.sLv + 1]) user.sLv++;
                save(); setTimeout(() => {
                    document.getElementById('res-coins').innerText = total;
                    document.getElementById('res-title').innerText = "STAGE " + oldLv + " CLEAR!";
                    document.getElementById('game-content').style.display = 'none';
                    document.getElementById('result-screen').style.display = 'flex';
                    if(user.clearCount === 2 || user.clearCount % 5 === 0) showLargeAd();
                }, 600);
            }
        }

        function initAdSystem() {
            const t = document.getElementById('ad-top'), b = document.getElementById('ad-bottom');
            let isTop = true;
            t.innerHTML = '<iframe src="ad.html" class="ad-frame"></iframe>';
            setInterval(() => {
                if(isTop) { t.style.display = 'none'; b.style.display = 'block'; b.innerHTML = '<iframe src="ad.html" class="ad-frame"></iframe>'; t.innerHTML = ''; }
                else { b.style.display = 'none'; t.style.display = 'block'; t.innerHTML = '<iframe src="ad.html" class="ad-frame"></iframe>'; b.innerHTML = ''; }
                isTop = !isTop;
            }, 30000);
        }

        function showLargeAd() {
            document.getElementById('ad-large-frame').src = 'ad.large.html';
            document.getElementById('ad-large-overlay').style.display = 'block';
            document.getElementById('ad-close-btn').style.display = 'none';
            let s = 5; const timer = document.getElementById('ad-timer'); timer.innerText = s + "s...";
            const itv = setInterval(() => {
                s--; if(s<=0) { clearInterval(itv); timer.style.display='none'; document.getElementById('ad-close-btn').style.display='block'; }
                else timer.innerText = s + "s...";
            }, 1000);
        }
        function closeLargeAd() { document.getElementById('ad-large-overlay').style.display = 'none'; }
        window.onload = load;
    </script>
</body>
</html>
