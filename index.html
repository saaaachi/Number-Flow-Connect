<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Number Flow Connect</title>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #3b82f6; --text: #f8fafc; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; user-select: none; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        .ad-sticky { width: 100%; height: 60px; background: #000; flex-shrink: 0; z-index: 1000; display: flex; justify-content: center; align-items: center; }
        iframe.ad-frame { width: 100%; height: 100%; border: none; }

        .main-container { flex: 1; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; }
        .screen { display: none; flex-direction: column; align-items: center; width: 100%; padding: 10px; }
        .screen.active { display: flex; }

        /* Â∑¶‰∏äÊàª„Çã„Éú„Çø„É≥ */
        .back-home-btn { position: absolute; top: 10px; left: 10px; padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid #475569; color: white; border-radius: 8px; font-size: 12px; cursor: pointer; z-index: 500; }

        /* Áõ§Èù¢Ôºövmin„Çí‰Ωø„Å£„Å¶Áµ∂ÂØæ„Å´Ê≠£ÊñπÂΩ¢„Çí‰øù„Å§ */
        .board-container {
            position: relative;
            width: 85vmin;
            height: 85vmin;
            max-width: 350px;
            max-height: 350px;
            background: var(--panel);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #grid { display: grid; width: 100%; height: 100%; gap: 5px; position: relative; z-index: 20; background: transparent; }
        .cell { background: #334155; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        
        /* Êï∞Â≠óÔºöÂÜÜÂΩ¢„ÇíÊ≠ªÂÆà */
        .dot { 
            width: 80%; height: 80%; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            color: white; font-weight: bold; font-size: 5vmin; 
            position: relative; z-index: 30; 
            border: 3px solid rgba(255,255,255,0.4);
        }

        canvas { position: absolute; top: 8px; left: 8px; pointer-events: none; z-index: 10; }

        .btn-main { background: #22c55e; color: white; padding: 15px 40px; border-radius: 12px; border: none; font-size: 20px; font-weight: bold; box-shadow: 0 4px 0 #15803d; }
        .shop-area { background: var(--panel); border-radius: 12px; width: 280px; padding: 15px; margin-top: 15px; border: 1px solid #334155; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 14px; }
        .buy-btn { padding: 6px 12px; border-radius: 6px; border: none; background: #8b5cf6; color: white; font-weight: bold; }
        .buy-btn.owned { background: #475569; }

        #ad-full-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; background:#000; }
        #ad-full-timer { position: absolute; top: 20px; right: 20px; color: white; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px; }
        #ad-full-close { position: absolute; top: 20px; right: 20px; padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 8px; display: none; font-weight: bold; }
    </style>
</head>
<body>

    <div id="ad-top" class="ad-sticky"></div>

    <div class="main-container">
        <div id="sc-home" class="screen active">
            <h1 style="color:#facc15; margin-bottom:10px;">Number Flow</h1>
            <div style="font-size:20px; color:#facc15; margin-bottom:20px;">üí∞ <span id="coin-home">0</span></div>
            <button class="btn-main" onclick="toGame()">PLAY START</button>
            <div class="shop-area">
                <div class="shop-item"><span>Creative Mode</span><button id="s-maker" class="buy-btn" onclick="buy('maker',5000)">5000C</button></div>
                <div class="shop-item"><span>Infinite Hints</span><button id="s-hints" class="buy-btn" onclick="buy('hints',2000)">2000C</button></div>
                <div class="shop-item"><span>No Ads</span><button id="s-noads" class="buy-btn" onclick="buy('noads',7000)">7000C</button></div>
            </div>
        </div>

        <div id="sc-game" class="screen">
            <button class="back-home-btn" onclick="confirmBack()">‚Üê Home (Penalty)</button>
            <div style="margin-bottom:10px;">Lv: <span id="ui-lv">1</span> | üí∞ <span id="ui-coin">0</span></div>
            <div class="board-container">
                <div id="grid"></div>
                <canvas id="canvas"></canvas>
            </div>
            <button onclick="initStage()" style="margin-top:15px; padding:8px 20px; background:#ef4444; border:none; color:white; border-radius:8px; font-weight:bold;">RESET</button>
        </div>

        <div id="sc-res" class="screen">
            <h1 id="res-title">CLEAR!</h1>
            <div style="font-size:32px; color:#facc15; margin:20px 0;">üí∞ +<span id="res-add">0</span></div>
            <button class="btn-main" onclick="toGame()">NEXT</button>
            <button onclick="toHome()" style="margin-top:20px; color:#94a3b8; background:none; border:none;">BACK TO HOME</button>
        </div>
    </div>

    <div id="ad-bottom" class="ad-sticky"></div>

    <div id="ad-full-overlay">
        <iframe id="ad-full-frame" style="width:100%; height:100%; border:none;"></iframe>
        <div id="ad-full-timer">5s...</div>
        <button id="ad-full-close" onclick="closeFullAd()">CLOSE [X]</button>
    </div>

    <script>
        const STAGES = {
            1: {s:5, d:[{x:0,y:0,v:1,c:'#ef4444'},{x:4,y:0,v:1,c:'#ef4444'},{x:0,y:2,v:2,c:'#3b82f6'},{x:4,y:2,v:2,c:'#3b82f6'},{x:0,y:4,v:3,c:'#22c55e'},{x:4,y:4,v:3,c:'#22c55e'}]},
            2: {s:5, d:[{x:2,y:1,v:1,c:'#ef4444'},{x:2,y:3,v:1,c:'#ef4444'},{x:0,y:0,v:2,c:'#3b82f6'},{x:1,y:0,v:2,c:'#3b82f6'},{x:1,y:1,v:3,c:'#22c55e'},{x:1,y:3,v:3,c:'#22c55e'}]},
            3: {s:5, d:[{x:0,y:0,v:1,c:'#ef4444'},{x:2,y:2,v:1,c:'#ef4444'},{x:4,y:4,v:2,c:'#3b82f6'},{x:2,y:4,v:2,c:'#3b82f6'},{x:0,y:4,v:3,c:'#22c55e'},{x:0,y:2,v:3,c:'#22c55e'}]},
            4: {s:5, d:[{x:0,y:1,v:1,c:'#ef4444'},{x:4,y:1,v:1,c:'#ef4444'},{x:0,y:3,v:2,c:'#3b82f6'},{x:4,y:3,v:2,c:'#3b82f6'},{x:2,y:0,v:3,c:'#22c55e'},{x:2,y:4,v:3,c:'#22c55e'}]},
            5: {s:6, d:[{x:0,y:0,v:1,c:'#ef4444'},{x:5,y:5,v:1,c:'#ef4444'},{x:0,y:5,v:2,c:'#3b82f6'},{x:5,y:0,v:2,c:'#3b82f6'},{x:2,y:2,v:3,c:'#22c55e'},{x:3,y:3,v:3,c:'#22c55e'}]},
            6: {s:6, d:[{x:1,y:1,v:1,c:'#ef4444'},{x:4,y:4,v:1,c:'#ef4444'},{x:1,y:4,v:2,c:'#3b82f6'},{x:4,y:1,v:2,c:'#3b82f6'},{x:0,y:0,v:3,c:'#22c55e'},{x:5,y:5,v:3,c:'#22c55e'}]},
            7: {s:6, d:[{x:0,y:0,v:1,c:'#ef4444'},{x:0,y:3,v:1,c:'#ef4444'},{x:1,y:0,v:2,c:'#3b82f6'},{x:1,y:3,v:2,c:'#3b82f6'},{x:2,y:0,v:3,c:'#22c55e'},{x:2,y:3,v:3,c:'#22c55e'},{x:3,y:0,v:4,c:'#facc15'},{x:3,y:3,v:4,c:'#facc15'}]},
            8: {s:7, d:[{x:0,y:0,v:1,c:'#ef4444'},{x:6,y:6,v:1,c:'#ef4444'},{x:6,y:0,v:2,c:'#3b82f6'},{x:0,y:6,v:2,c:'#3b82f6'},{x:3,y:0,v:3,c:'#22c55e'},{x:3,y:6,v:3,c:'#22c55e'}]},
            9: {s:7, d:[{x:0,y:0,v:1,c:'#ef4444'},{x:1,y:1,v:1,c:'#ef4444'},{x:2,y:2,v:2,c:'#3b82f6'},{x:3,y:3,v:2,c:'#3b82f6'},{x:4,y:4,v:3,c:'#22c55e'},{x:5,y:5,v:3,c:'#22c55e'}]},
            10:{s:8, d:[{x:0,y:0,v:1,c:'#ef4444'},{x:7,y:7,v:1,c:'#ef4444'},{x:7,y:0,v:2,c:'#3b82f6'},{x:0,y:7,v:2,c:'#3b82f6'},{x:3,y:3,v:3,c:'#22c55e'},{x:4,y:4,v:3,c:'#22c55e'}]}
        };

        let user = { coins: 0, lv: 1, maker: false, hints: false, noads: false, actionCount: 0 };
        let dots = [], completed = [], current = [], gridSize = 5, drawing = false, activeColor = '';
        const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');

        window.onload = () => {
            const s = localStorage.getItem('flow_final_v5');
            if(s) user = Object.assign(user, JSON.parse(s));
            updateUI();
            startAdTimer();
        };

        function updateUI() {
            document.getElementById('coin-home').innerText = user.coins;
            document.getElementById('ui-coin').innerText = user.coins;
            document.getElementById('ui-lv').innerText = user.lv;
            ['maker','hints','noads'].forEach(id => {
                if(user[id]) { 
                    const b = document.getElementById('s-'+id);
                    b.innerText = (id==='maker') ? "OPEN" : "ACTIVE";
                    b.classList.add('owned');
                }
            });
            localStorage.setItem('flow_final_v5', JSON.stringify(user));
        }

        function toScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function toGame() { toScreen('sc-game'); initStage(); }
        function toHome() { toScreen('sc-home'); updateUI(); }

        function buy(id, p) {
            if(user[id]) { if(id==='maker') window.open('maker.html','_blank'); return; }
            if(user.coins >= p) { user.coins -= p; user[id] = true; updateUI(); }
            else alert("No coins!");
        }

        function confirmBack() {
            if(confirm("Êú¨ÂΩì„Å´Êàª„Çä„Åæ„Åô„ÅãÔºü‰ªäÁç≤Âæó„Åó„Å¶„Çã„Ç≥„Ç§„É≥„ÅÆÂçäÂàÜ„Å´„Å™„Çä„Åæ„Åô")) {
                user.coins = Math.floor(user.coins / 2);
                countAdAction();
                toHome();
            }
        }

        function initStage() {
            const data = STAGES[user.lv] || STAGES[1];
            gridSize = data.s; dots = data.d;
            completed = []; current = [];
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;

            for(let i=0; i<gridSize*gridSize; i++){
                const cell = document.createElement('div'), x=i%gridSize, y=Math.floor(i/gridSize);
                cell.className = 'cell';
                const d = dots.find(dot => dot.x === x && dot.y === y);
                if(d) {
                    const el = document.createElement('div');
                    el.className = 'dot'; el.style.backgroundColor = d.c; el.innerText = d.v;
                    cell.appendChild(el);
                }
                grid.appendChild(cell);
            }
            setTimeout(() => {
                const side = document.querySelector('.board-container').clientWidth - 16;
                canvas.width = side; canvas.height = side;
                draw();
            }, 100);
        }

        function getPos(e) {
            const rect = document.getElementById('grid').getBoundingClientRect();
            const t = e.touches ? e.touches[0] : e;
            const x = Math.floor((t.clientX - rect.left) / (rect.width / gridSize));
            const y = Math.floor((t.clientY - rect.top) / (rect.height / gridSize));
            return (x>=0 && x<gridSize && y>=0 && y<gridSize) ? {x,y} : null;
        }

        document.getElementById('grid').addEventListener('touchstart', (e) => {
            const p = getPos(e); if(!p) return;
            const d = dots.find(dot => dot.x === p.x && dot.y === p.y);
            if(d) {
                drawing = true; activeColor = d.c;
                completed = completed.filter(path => dots.find(dot => dot.x === path[0].x && dot.y === path[0].y).c !== activeColor);
                current = [p]; draw();
            }
        });

        document.getElementById('grid').addEventListener('touchmove', (e) => {
            if(!drawing) return;
            const p = getPos(e); if(!p) return;
            const last = current[current.length-1];
            if(p.x === last.x && p.y === last.y) return;
            if(Math.abs(p.x - last.x) + Math.abs(p.y - last.y) === 1) {
                if(completed.some(path => path.some(pt => pt.x === p.x && pt.y === p.y))) return;
                if(current.some(pt => pt.x === p.x && pt.y === p.y)) {
                    if(current.length > 1 && p.x === current[current.length-2].x && p.y === current[current.length-2].y) current.pop();
                } else {
                    current.push(p);
                    const target = dots.find(dot => dot.x === p.x && dot.y === p.y);
                    if(target && target.c === activeColor) {
                        completed.push([...current]); drawing = false; check();
                    }
                }
                draw();
            }
        });
        window.addEventListener('touchend', () => { drawing = false; current = []; draw(); });

        function draw() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            const s = canvas.width / gridSize;
            const line = (p, c) => {
                ctx.beginPath(); ctx.strokeStyle = c; ctx.lineWidth = canvas.width/15; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                p.forEach((pt, i) => {
                    const x = pt.x * s + s/2, y = pt.y * s + s/2;
                    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                });
                ctx.stroke();
            };
            completed.forEach(p => line(p, dots.find(d => d.x === p[0].x && d.y === p[0].y).c));
            if(current.length > 0) line(current, activeColor);
        }

        function check() {
            if(completed.length === dots.length / 2) {
                const add = completed.length * 100;
                user.coins += add; user.actionCount++;
                const old = user.lv; if(STAGES[user.lv+1]) user.lv++;
                updateUI();
                setTimeout(() => {
                    document.getElementById('res-add').innerText = add;
                    document.getElementById('res-title').innerText = "STAGE " + old + " CLEAR!";
                    toScreen('sc-res');
                    if(!user.noads && (user.actionCount === 2 || (user.actionCount > 2 && (user.actionCount - 2) % 5 === 0))) showFullAd();
                }, 500);
            }
        }

        function countAdAction() {
            user.actionCount++; updateUI();
            if(!user.noads && (user.actionCount === 2 || (user.actionCount > 2 && (user.actionCount - 2) % 5 === 0))) showFullAd();
        }

        function startAdTimer() {
            const t = document.getElementById('ad-top'), b = document.getElementById('ad-bottom');
            let flip = true;
            setInterval(() => {
                t.innerHTML = flip ? '<iframe src="ad.html" class="ad-frame"></iframe>' : '';
                b.innerHTML = !flip ? '<iframe src="ad.html" class="ad-frame"></iframe>' : '';
                flip = !flip;
            }, 30000);
            t.innerHTML = '<iframe src="ad.html" class="ad-frame"></iframe>';
        }

        function showFullAd() {
            document.getElementById('ad-full-frame').src = 'ad.large.html';
            document.getElementById('ad-full-overlay').style.display = 'block';
            let s = 5; const timer = document.getElementById('ad-full-timer');
            timer.style.display = 'block'; timer.innerText = s + "s...";
            const itv = setInterval(() => {
                s--; if(s<=0) { clearInterval(itv); timer.style.display='none'; document.getElementById('ad-full-close').style.display='block'; }
                else timer.innerText = s + "s...";
            }, 1000);
        }
        function closeFullAd() { document.getElementById('ad-full-overlay').style.display = 'none'; document.getElementById('ad-full-close').style.display = 'none'; }
    </script>
</body>
</html>
