<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Number Flow Connect</title>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #3b82f6; --text: #f8fafc; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; user-select: none; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* ä¸Šä¸‹åºƒå‘Šï¼šçµ¶å¯¾ã«é«˜ã•ã‚’ç¢ºä¿ */
        .ad-sticky { width: 100%; height: 65px; background: #000; flex-shrink: 0; z-index: 1000; display: flex; justify-content: center; align-items: center; }
        iframe.ad-frame { width: 100%; height: 100%; border: none; }

        .main-container { flex: 1; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; overflow: hidden; }

        .screen { display: none; flex-direction: column; align-items: center; width: 100%; animation: fadeIn 0.3s ease; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ã‚·ãƒ§ãƒƒãƒ—ï¼šã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«åŸ‹ã‚è¾¼ã¿ */
        .start-shop { background: var(--panel); border-radius: 12px; width: 280px; padding: 15px; margin-top: 15px; border: 1px solid #334155; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 14px; }
        .buy-btn { padding: 6px 12px; border-radius: 6px; border: none; background: #8b5cf6; color: white; font-weight: bold; cursor: pointer; min-width: 80px; }
        .buy-btn.own { background: #475569; }

        .btn-green { background: #22c55e; color: white; padding: 15px 40px; border-radius: 12px; border: none; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #15803d; }
        .btn-green:active { transform: translateY(2px); box-shadow: none; }

        /* ç›¤é¢ã‚¨ãƒªã‚¢ï¼šå®Œå…¨ãªæ­£æ–¹å½¢ã‚’ç¶­æŒ */
        .game-board-wrapper {
            position: relative;
            width: 100%;
            max-width: 320px; /* æ¨ªå¹…ã®é™ç•Œ */
            aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢å›ºå®š */
            background: var(--panel);
            border-radius: 8px;
            padding: 8px;
        }

        #grid { 
            display: grid; 
            width: 100%; 
            height: 100%; 
            gap: 4px; 
            position: relative; 
            z-index: 10; /* Canvas(5)ã‚ˆã‚Šä¸Šã«é…ç½®ã—ã¦ã‚¿ãƒƒãƒ—ã‚’æ¤œçŸ¥ */
            background: transparent;
        }

        .cell { 
            background: #334155; 
            border-radius: 4px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative;
            pointer-events: none; /* ã‚»ãƒ«è‡ªä½“ã§ã¯ãªãã‚°ãƒªãƒƒãƒ‰å…¨ä½“ã§æ¤œçŸ¥ */
        }
        
        /* æ•°å­—ã®å††å½¢ãƒ‡ã‚¶ã‚¤ãƒ³ï¼šCanvasã‚ˆã‚Šä¸Šã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«èª¿æ•´ */
        .dot { 
            width: 80%; 
            height: 80%; 
            aspect-ratio: 1/1; 
            border-radius: 50%; /* çµ¶å¯¾ã«å††å½¢ */
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: bold; 
            font-size: 20px; 
            z-index: 20; /* ç·šã®Canvas(5)ã‚ˆã‚Šä¸Šã« */
            position: relative;
            border: 3px solid rgba(255,255,255,0.4);
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        canvas { 
            position: absolute; 
            top: 8px; 
            left: 8px; 
            pointer-events: none; 
            z-index: 5; /* æ•°å­—ã‚ˆã‚Šä¸‹ã€ãƒã‚¹ç›®ã‚ˆã‚Šä¸Š */
        }

        .hud { font-size: 18px; color: #facc15; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="ad-top" class="ad-sticky"></div>

    <div class="main-container">
        <div id="screen-start" class="screen active">
            <h1 style="color:#facc15; margin-bottom:10px;">Number Flow</h1>
            <div class="hud">ğŸ’° <span id="coin-start">0</span></div>
            <button class="btn-green" onclick="showScreen('screen-game'); initGame();">START</button>

            <div class="start-shop">
                <div class="shop-item">
                    <span>Creative Mode</span>
                    <button id="btn-maker" class="buy-btn" onclick="shopAction('maker', 5000)">5000C</button>
                </div>
                <div class="shop-item">
                    <span>Infinite Hints</span>
                    <button id="btn-hints" class="buy-btn" onclick="shopAction('hints', 2000)">2000C</button>
                </div>
                <div class="shop-item">
                    <span>No Ads (Perm)</span>
                    <button id="btn-noads" class="buy-btn" onclick="shopAction('noads', 7000)">7000C</button>
                </div>
            </div>
        </div>

        <div id="screen-game" class="screen">
            <div class="hud">Lv: <span id="ui-lv">1</span> | ğŸ’° <span id="ui-coin">0</span></div>
            <div class="game-board-wrapper">
                <div id="grid"></div>
                <canvas id="canvas"></canvas>
            </div>
            <button onclick="initGame()" style="margin-top:15px; padding:8px 20px; background:#ef4444; border:none; color:white; border-radius:8px; font-weight:bold;">RESET</button>
        </div>

        <div id="screen-result" class="screen">
            <h1 id="res-msg">STAGE CLEAR!</h1>
            <div style="font-size:32px; color:#facc15; margin:20px 0;">ğŸ’° +<span id="res-gain">0</span></div>
            <button class="btn-green" onclick="showScreen('screen-game'); initGame();">NEXT</button>
            <button onclick="showScreen('screen-start')" style="margin-top:15px; color:#94a3b8; background:none; border:none;">BACK TO HOME</button>
        </div>
    </div>

    <div id="ad-bottom" class="ad-sticky"></div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
        const stages = {
            1: {size:5, dots:[{x:0,y:0,v:1,c:'#ef4444'},{x:4,y:0,v:1,c:'#ef4444'},{x:0,y:2,v:2,c:'#3b82f6'},{x:4,y:2,v:2,c:'#3b82f6'},{x:0,y:4,v:3,c:'#22c55e'},{x:4,y:4,v:3,c:'#22c55e'}]},
            2: {size:5, dots:[{x:2,y:1,v:1,c:'#ef4444'},{x:2,y:3,v:1,c:'#ef4444'},{x:0,y:0,v:2,c:'#3b82f6'},{x:1,y:0,v:2,c:'#3b82f6'},{x:1,y:1,v:3,c:'#22c55e'},{x:1,y:3,v:3,c:'#22c55e'}]}
        };

        let user = { coins: 0, lv: 1, maker: false, hints: false, noads: false, clears: 0 };
        let currentDots = [], completedPaths = [], currentPath = [], gridSize = 5, isDrawing = false, activeColor = null;
        
        const cvs = document.getElementById('canvas');
        const ctx = cvs.getContext('2d');

        // åˆæœŸåŒ–
        window.onload = () => {
            const saved = localStorage.getItem('flow_final_v4');
            if(saved) user = Object.assign(user, JSON.parse(saved));
            updateUI();
            initAdSystem();
        };

        function updateUI() {
            document.getElementById('coin-start').innerText = user.coins;
            document.getElementById('ui-coin').innerText = user.coins;
            document.getElementById('ui-lv').innerText = user.lv;
            
            if(user.maker) { document.getElementById('btn-maker').innerText = "OPEN"; document.getElementById('btn-maker').className="buy-btn own"; }
            if(user.hints) { document.getElementById('btn-hints').innerText = "OWNED"; document.getElementById('btn-hints').className="buy-btn own"; }
            if(user.noads) { document.getElementById('btn-noads').innerText = "OWNED"; document.getElementById('btn-noads').className="buy-btn own"; }
            localStorage.setItem('flow_final_v4', JSON.stringify(user));
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function shopAction(id, price) {
            if(user[id]) { if(id==='maker') window.open('maker.html','_blank'); return; }
            if(user.coins >= price) {
                user.coins -= price; user[id] = true; updateUI();
            } else alert("Coins not enough!");
        }

        function initGame() {
            const data = stages[user.lv] || stages[1];
            gridSize = data.size; currentDots = data.dots;
            completedPaths = []; currentPath = [];
            
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;

            // å…¨ã‚»ãƒ«ä½œæˆ
            for(let y=0; y<gridSize; y++) {
                for(let x=0; x<gridSize; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    const dotData = currentDots.find(d => d.x === x && d.y === y);
                    if(dotData) {
                        const d = document.createElement('div');
                        d.className = 'dot'; d.style.backgroundColor = dotData.c; d.innerText = dotData.v;
                        cell.appendChild(d);
                    }
                    grid.appendChild(cell);
                }
            }
            // Canvasã‚µã‚¤ã‚ºã‚’ã‚³ãƒ³ãƒ†ãƒŠã«åˆã‚ã›ã‚‹
            setTimeout(() => {
                const side = document.querySelector('.game-board-wrapper').clientWidth - 16;
                cvs.width = side; cvs.height = side;
                render();
            }, 50);
        }

        // ã‚¿ãƒƒãƒæ“ä½œ
        function getCell(e) {
            const rect = document.getElementById('grid').getBoundingClientRect();
            const t = e.touches ? e.touches[0] : e;
            const x = Math.floor((t.clientX - rect.left) / (rect.width / gridSize));
            const y = Math.floor((t.clientY - rect.top) / (rect.height / gridSize));
            return (x>=0 && x<gridSize && y>=0 && y<gridSize) ? {x,y} : null;
        }

        document.getElementById('grid').addEventListener('touchstart', (e) => {
            const pos = getCell(e); if(!pos) return;
            const startDot = currentDots.find(d => d.x === pos.x && d.y === pos.y);
            if(startDot) {
                isDrawing = true; activeColor = startDot.c;
                // åŒã˜è‰²ã®æ—¢å­˜ãƒ©ã‚¤ãƒ³ã‚’æ¶ˆå»
                completedPaths = completedPaths.filter(p => currentDots.find(d => d.x === p[0].x && d.y === p[0].y).c !== activeColor);
                currentPath = [pos]; render();
            }
        });

        document.getElementById('grid').addEventListener('touchmove', (e) => {
            if(!isDrawing) return;
            const pos = getCell(e); if(!pos) return;
            const last = currentPath[currentPath.length-1];
            if(pos.x === last.x && pos.y === last.y) return;

            // éš£æ¥ãƒã‚§ãƒƒã‚¯
            if(Math.abs(pos.x - last.x) + Math.abs(pos.y - last.y) === 1) {
                // ä»–ã®å®Œæˆãƒ©ã‚¤ãƒ³ã¨ã®è¡çª
                if(completedPaths.some(p => p.some(pt => pt.x === pos.x && pt.y === pos.y))) return;
                
                if(currentPath.some(pt => pt.x === pos.x && pt.y === pos.y)) {
                    // æˆ»ã‚‹æ“ä½œ
                    if(currentPath.length > 1 && pos.x === currentPath[currentPath.length-2].x && pos.y === currentPath[currentPath.length-2].y) currentPath.pop();
                } else {
                    currentPath.push(pos);
                    // ã‚´ãƒ¼ãƒ«åˆ¤å®š
                    const target = currentDots.find(d => d.x === pos.x && d.y === pos.y);
                    if(target && target.c === activeColor) {
                        completedPaths.push([...currentPath]);
                        isDrawing = false;
                        checkClear();
                    }
                }
                render();
            }
        });

        window.addEventListener('touchend', () => { isDrawing = false; currentPath = []; render(); });

        function render() {
            ctx.clearRect(0,0,cvs.width,cvs.height);
            const s = cvs.width / gridSize;
            const drawP = (path, color) => {
                ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 15; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                path.forEach((p, i) => {
                    const x = p.x * s + s/2; const y = p.y * s + s/2;
                    if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();
            };
            completedPaths.forEach(p => drawP(p, currentDots.find(d => d.x === p[0].x && d.y === p[0].y).c));
            if(currentPath.length > 0) drawP(currentPath, activeColor);
        }

        function checkClear() {
            if(completedPaths.length === currentDots.length / 2) {
                const gain = completedPaths.length * 100;
                user.coins += gain; user.clears++;
                const oldLv = user.lv;
                if(stages[user.lv + 1]) user.lv++;
                updateUI();
                setTimeout(() => {
                    document.getElementById('res-gain').innerText = gain;
                    document.getElementById('res-msg').innerText = `STAGE ${oldLv} CLEAR!`;
                    showScreen('screen-result');
                }, 500);
            }
        }

        // åºƒå‘Šã‚·ã‚¹ãƒ†ãƒ 
        function initAdSystem() {
            const t = document.getElementById('ad-top'), b = document.getElementById('ad-bottom');
            let isTop = true;
            const refresh = () => {
                if(isTop) {
                    t.innerHTML = '<iframe src="ad.html" class="ad-frame"></iframe>'; t.style.display = 'flex';
                    b.innerHTML = ''; b.style.display = 'none';
                } else {
                    b.innerHTML = '<iframe src="ad.html" class="ad-frame"></iframe>'; b.style.display = 'flex';
                    t.innerHTML = ''; t.style.display = 'none';
                }
                isTop = !isTop;
            };
            refresh();
            setInterval(refresh, 30000);
        }
    </script>
</body>
</html>
