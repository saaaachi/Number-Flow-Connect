<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Number Flow Connect</title>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #3b82f6; --text: #f8fafc; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; user-select: none; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* åºƒå‘Šæ ï¼ˆé«˜ã•å›ºå®šï¼‰ */
        .ad-area { width: 100%; height: 65px; background: #000; flex-shrink: 0; display: flex; justify-content: center; align-items: center; z-index: 100; }
        iframe.ad-frame { width: 100%; height: 100%; border: none; }

        /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ */
        .screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; position: relative; }
        h1 { font-size: 24px; color: #facc15; margin-bottom: 15px; }
        
        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®ã‚·ãƒ§ãƒƒãƒ—è¦ç´  */
        .shop-container { background: var(--panel); padding: 15px; border-radius: 15px; width: 260px; margin: 15px 0; border: 1px solid #334155; }
        .item-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .buy-btn { padding: 8px 12px; border-radius: 8px; border: none; background: #8b5cf6; color: white; font-size: 12px; font-weight: bold; cursor: pointer; }
        .buy-btn.unlocked { background: #475569; pointer-events: none; }

        .menu-btn { width: 220px; padding: 14px; border-radius: 12px; border: none; background: #22c55e; color: white; font-weight: bold; font-size: 18px; cursor: pointer; }
        
        /* ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ï¼šæ­£æ–¹å½¢ã‚’ç¶­æŒ */
        #game-container { position: relative; width: 300px; height: 300px; background: var(--panel); border-radius: 10px; padding: 5px; }
        #grid { display: grid; width: 100%; height: 100%; gap: 5px; position: relative; z-index: 10; }
        .cell { background: #334155; border-radius: 4px; display: flex; align-items: center; justify-content: center; position: relative; }
        
        /* ç·šã‚’æãCanvasï¼šã‚°ãƒªãƒƒãƒ‰ã®ä¸‹ã«é…ç½® */
        canvas { position: absolute; top: 5px; left: 5px; pointer-events: none; z-index: 5; }

        /* æ•°å­—ï¼šå††å½¢ & ä¸é€æ˜èƒŒæ™¯ */
        .dot { 
            width: 85%; height: 85%; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            color: white; font-weight: bold; font-size: 20px; 
            z-index: 20; position: relative; 
            border: 2px solid rgba(255,255,255,0.7);
            background-color: inherit; /* å„è‰²ã®èƒŒæ™¯ã‚’ä¿æŒ */
        }

        .stats { font-size: 18px; color: #facc15; font-weight: bold; margin-bottom: 10px; }
        
        /* å¤§ç”»é¢åºƒå‘Š */
        #ad-large-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background:#000; }
        #ad-close-btn { position: absolute; top: 20px; right: 20px; padding: 10px 15px; background: #ef4444; color: white; border: none; border-radius: 8px; display: none; }
    </style>
</head>
<body>

    <div id="ad-top" class="ad-area"></div>

    <div id="start-screen" class="screen">
        <h1>Number Flow Connect</h1>
        
        <div class="stats">ğŸ’° <span id="start-coins">0</span></div>

        <button class="menu-btn" onclick="startGame()">START GAME</button>

        <div class="shop-container">
            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px;">SHOP (Liberation)</div>
            <div class="item-row">
                <span style="font-size:14px;">Maker Mode</span>
                <button id="buy-maker-btn" class="buy-btn" onclick="buyMaker()">5000 COIN</button>
            </div>
            <div style="font-size: 10px; color: #64748b;">â€»Unlocked maker will open in new tab</div>
        </div>

        <a href="https://saaaachi.github.io/Sort-Master/" target="_blank" style="color:#94a3b8; font-size:12px; text-decoration: none;">Sort Master ğŸ”—</a>
    </div>

    <div id="result-screen" class="screen" style="display:none;">
        <h1 id="res-title">CLEARED!</h1>
        <div style="font-size:32px; margin-bottom:20px; color:#facc15;">ğŸ’° +<span id="res-coins">0</span></div>
        <button class="menu-btn" onclick="startGame()">NEXT STAGE</button>
        <button class="menu-btn" onclick="backToStart()" style="background:#64748b; margin-top:10px; font-size:14px;">HOME</button>
    </div>

    <div id="game-screen" class="screen" style="display:none;">
        <div class="stats">
            Lv: <span id="ui-stage">1</span> | ğŸ’° <span id="ui-coins">0</span>
        </div>
        <div id="game-container">
            <div id="grid"></div>
            <canvas id="line-canvas" width="290" height="290"></canvas>
        </div>
        <button onclick="initStage()" style="background:#ef4444; color:white; border:none; padding:8px 20px; border-radius:8px; margin-top:15px; font-weight:bold;">RESET</button>
    </div>

    <div id="ad-bottom" class="ad-area" style="display:none;"></div>

    <div id="ad-large-overlay">
        <iframe id="ad-large-frame" style="width:100%; height:100%; border:none;"></iframe>
        <div id="ad-timer" style="position:absolute; top:20px; right:20px; color:white; background:rgba(0,0,0,0.5); padding:10px;">5s...</div>
        <button id="ad-close-btn" onclick="closeLargeAd()">CLOSE [X]</button>
    </div>

    <script>
        // --- å…±é€šãƒ‡ãƒ¼ã‚¿ & ã‚»ãƒ¼ãƒ– ---
        const allStages = {
            1: {"size":5,"dots":[{"x":0,"y":0,"val":1,"color":"#ef4444"},{"x":4,"y":0,"val":1,"color":"#ef4444"},{"x":0,"y":2,"val":2,"color":"#3b82f6"},{"x":4,"y":2,"val":2,"color":"#3b82f6"},{"x":0,"y":4,"val":3,"color":"#22c55e"},{"x":4,"y":4,"val":3,"color":"#22c55e"}]},
            2: {"size":5,"dots":[{"x":2,"y":1,"val":1,"color":"#ef4444"},{"x":2,"y":3,"val":1,"color":"#ef4444"},{"x":0,"y":0,"val":2,"color":"#3b82f6"},{"x":1,"y":0,"val":2,"color":"#3b82f6"},{"x":1,"y":1,"val":3,"color":"#22c55e"},{"x":1,"y":3,"val":3,"color":"#22c55e"}]},
            3: {"size":5,"dots":[{"x":0,"y":0,"val":1,"color":"#ef4444"},{"x":4,"y":4,"val":1,"color":"#ef4444"},{"x":1,"y":1,"val":2,"color":"#3b82f6"},{"x":3,"y":3,"val":2,"color":"#3b82f6"},{"x":2,"y":1,"val":3,"color":"#22c55e"},{"x":3,"y":0,"val":3,"color":"#22c55e"}]},
            4: {"size":5,"dots":[{"x":2,"y":1,"val":1,"color":"#ef4444"},{"x":2,"y":3,"val":1,"color":"#ef4444"},{"x":0,"y":0,"val":2,"color":"#3b82f6"},{"x":4,"y":0,"val":2,"color":"#3b82f6"},{"x":1,"y":0,"val":3,"color":"#22c55e"},{"x":1,"y":2,"val":3,"color":"#22c55e"},{"x":3,"y":0,"val":4,"color":"#facc15"},{"x":3,"y":2,"val":4,"color":"#facc15"}]},
            5: {"size":5,"dots":[{"x":0,"y":0,"val":1,"color":"#ef4444"},{"x":2,"y":2,"val":1,"color":"#ef4444"},{"x":1,"y":1,"val":2,"color":"#3b82f6"},{"x":3,"y":3,"val":2,"color":"#3b82f6"},{"x":1,"y":0,"val":3,"color":"#22c55e"},{"x":4,"y":3,"val":3,"color":"#22c55e"},{"x":0,"y":3,"val":4,"color":"#facc15"},{"x":4,"y":4,"val":4,"color":"#facc15"}]},
            6: {"size":5,"dots":[{"x":1,"y":1,"val":1,"color":"#ef4444"},{"x":2,"y":3,"val":1,"color":"#ef4444"},{"x":1,"y":2,"val":2,"color":"#3b82f6"},{"x":4,"y":2,"val":2,"color":"#3b82f6"},{"x":3,"y":2,"val":3,"color":"#22c55e"},{"x":3,"y":0,"val":3,"color":"#22c55e"},{"x":2,"y":0,"val":4,"color":"#facc15"},{"x":0,"y":0,"val":4,"color":"#facc15"}]},
            7: {"size":5,"dots":[{"x":4,"y":0,"val":1,"color":"#ef4444"},{"x":3,"y":4,"val":1,"color":"#ef4444"},{"x":4,"y":2,"val":2,"color":"#3b82f6"},{"x":1,"y":2,"val":2,"color":"#3b82f6"},{"x":1,"y":3,"val":3,"color":"#22c55e"},{"x":4,"y":4,"val":3,"color":"#22c55e"},{"x":1,"y":1,"val":4,"color":"#facc15"},{"x":2,"y":1,"val":4,"color":"#facc15"},{"x":3,"y":1,"val":5,"color":"#a855f7"},{"x":4,"y":1,"val":5,"color":"#a855f7"}]}
        };

        let user = { coins: 0, sLv: 1, unlockedMaker: false, clearCount: 0 };
        let dots = [], completedPaths = [], currentPath = [], gridSize = 5, isDragging = false, activeColor = null;
        const ctx = document.getElementById('line-canvas').getContext('2d');

        function load() {
            const saved = localStorage.getItem('flow_final_save');
            if(saved) user = Object.assign(user, JSON.parse(saved));
            updateStats();
            initAdLoop();
        }
        function save() { localStorage.setItem('flow_final_save', JSON.stringify(user)); }

        function updateStats() {
            document.getElementById('start-coins').innerText = user.coins;
            document.getElementById('ui-coins').innerText = user.coins;
            document.getElementById('ui-stage').innerText = user.sLv;
            const btn = document.getElementById('buy-maker-btn');
            if(user.unlockedMaker) { btn.innerText = "OPENED"; btn.className = "buy-btn unlocked"; }
        }

        function buyMaker() {
            if(user.unlockedMaker) { window.open('maker.html', '_blank'); return; }
            if(user.coins >= 5000) {
                user.coins -= 5000; user.unlockedMaker = true;
                save(); updateStats();
            } else alert("Coin short! Play more!");
        }

        function startGame() {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('game-screen').style.display = 'flex';
            initStage();
        }
        function backToStart() {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('start-screen').style.display = 'flex';
            updateStats();
        }

        // --- ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ ---
        function initStage() {
            const data = allStages[user.sLv] || allStages[1];
            gridSize = data.size; dots = data.dots;
            completedPaths = []; currentPath = [];
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
            
            dots.forEach(d => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.style.gridColumnStart = d.x + 1; cell.style.gridRowStart = d.y + 1;
                const dot = document.createElement('div');
                dot.className = 'dot'; dot.style.backgroundColor = d.color; dot.innerText = d.val;
                cell.appendChild(dot);
                grid.appendChild(cell);
            });
            for(let i=0; i<gridSize*gridSize; i++) {
                if(!dots.find(d => d.x === i%gridSize && d.y === Math.floor(i/gridSize))) {
                    const cell = document.createElement('div'); cell.className = 'cell'; grid.appendChild(cell);
                }
            }
            draw();
        }

        function getPos(e) {
            const rect = document.getElementById('grid').getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            const x = Math.floor((touch.clientX - rect.left) / (rect.width / gridSize));
            const y = Math.floor((touch.clientY - rect.top) / (rect.height / gridSize));
            return (x>=0 && x<gridSize && y>=0 && y<gridSize) ? {x, y} : null;
        }

        document.getElementById('grid').addEventListener('touchstart', (e) => {
            const pos = getPos(e); if(!pos) return;
            const dot = dots.find(d => d.x === pos.x && d.y === pos.y);
            if(dot) {
                isDragging = true; activeColor = dot.color;
                completedPaths = completedPaths.filter(p => dots.find(d => d.x === p[0].x && d.y === p[0].y).color !== activeColor);
                currentPath = [pos]; draw();
            }
        });

        document.getElementById('grid').addEventListener('touchmove', (e) => {
            if(!isDragging) return;
            const pos = getPos(e); if(!pos) return;
            const last = currentPath[currentPath.length-1];
            if(pos.x === last.x && pos.y === last.y) return;
            if(Math.abs(pos.x - last.x) + Math.abs(pos.y - last.y) === 1) {
                if(completedPaths.some(p => p.some(pt => pt.x === pos.x && pt.y === pos.y))) return;
                if(currentPath.some(pt => pt.x === pos.x && pt.y === pos.y)) {
                    if(currentPath.length > 1 && pos.x === currentPath[currentPath.length-2].x && pos.y === currentPath[currentPath.length-2].y) currentPath.pop();
                } else {
                    currentPath.push(pos);
                    const goal = dots.find(d => d.x === pos.x && d.y === pos.y);
                    if(goal && goal.color === activeColor) { completedPaths.push([...currentPath]); isDragging = false; checkClear(); }
                }
                draw();
            }
        });
        window.addEventListener('touchend', () => { isDragging = false; currentPath = []; draw(); });

        function draw() {
            ctx.clearRect(0,0,290,290);
            const s = 290 / gridSize;
            const drawL = (p, c) => {
                ctx.beginPath(); ctx.strokeStyle = c; ctx.lineWidth = 14; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                p.forEach((pt, i) => {
                    const x = pt.x * s + s/2; const y = pt.y * s + s/2;
                    if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();
            };
            completedPaths.forEach(p => drawL(p, dots.find(d => d.x === p[0].x && d.y === p[0].y).color));
            if(currentPath.length > 0) drawL(currentPath, activeColor);
        }

        function checkClear() {
            if(completedPaths.length === dots.length / 2) {
                const gain = (completedPaths.length * 100);
                user.coins += gain; user.clearCount++;
                const oldLv = user.sLv;
                if(allStages[user.sLv + 1]) user.sLv++;
                save(); 
                setTimeout(() => {
                    document.getElementById('res-coins').innerText = gain;
                    document.getElementById('res-title').innerText = "STAGE " + oldLv + " CLEAR!";
                    document.getElementById('game-screen').style.display = 'none';
                    document.getElementById('result-screen').style.display = 'flex';
                    if(user.clearCount === 2 || user.clearCount % 5 === 0) showLargeAd();
                }, 500);
            }
        }

        // --- åºƒå‘Šåˆ¶å¾¡ ---
        function initAdLoop() {
            const t = document.getElementById('ad-top'), b = document.getElementById('ad-bottom');
            let isTop = true;
            const updateAd = () => {
                if(isTop) {
                    t.innerHTML = '<iframe src="ad.html" class="ad-frame"></iframe>'; t.style.display = 'flex';
                    b.innerHTML = ''; b.style.display = 'none';
                } else {
                    b.innerHTML = '<iframe src="ad.html" class="ad-frame"></iframe>'; b.style.display = 'flex';
                    t.innerHTML = ''; t.style.display = 'none';
                }
                isTop = !isTop;
            };
            updateAd();
            setInterval(updateAd, 30000);
        }

        function showLargeAd() {
            document.getElementById('ad-large-frame').src = 'ad.large.html';
            document.getElementById('ad-large-overlay').style.display = 'block';
            let sec = 5; const timer = document.getElementById('ad-timer');
            timer.style.display = 'block'; timer.innerText = sec + "s...";
            const intv = setInterval(() => {
                sec--; if(sec<=0) { clearInterval(itv); timer.style.display='none'; document.getElementById('ad-close-btn').style.display='block'; }
                else timer.innerText = sec + "s...";
            }, 1000);
        }
        function closeLargeAd() { document.getElementById('ad-large-overlay').style.display = 'none'; document.getElementById('ad-close-btn').style.display = 'none'; }

        window.onload = load;
    </script>
</body>
</html>
